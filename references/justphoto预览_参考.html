<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Just Photo â€” Camera Prototype (Frontend Only)</title>
  <style>
    :root {
      --bg: #0b0c10;
      --panel: rgba(255, 255, 255, .08);
      --panel2: rgba(255, 255, 255, .12);
      --text: rgba(255, 255, 255, .92);
      --muted: rgba(255, 255, 255, .7);
      --muted2: rgba(255, 255, 255, .55);
      --danger: #ff4d4f;
      --ok: #24c46b;
      --shadow: 0 12px 30px rgba(0, 0, 0, .35);
      --radius: 18px;
      --safe: 14px;
      --phoneW: 393px;
      --phoneH: 852px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 10%, rgba(255, 255, 255, .08), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255, 255, 255, .06), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .wrap {
      display: flex;
      gap: 18px;
      align-items: flex-start;
      justify-content: center;
      flex-wrap: wrap;
    }

    .phone {
      width: min(var(--phoneW), 92vw);
      height: min(var(--phoneH), 92vh);
      background: #0a0a0a;
      border-radius: 36px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0, 0, 0, .55);
      border: 1px solid rgba(255, 255, 255, .12);
    }

    .statusbar {
      height: 28px;
      padding: 10px 14px 0;
      font-size: 12px;
      color: rgba(255, 255, 255, .65);
      display: flex;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
    }

    .screen.active {
      display: block
    }

    /* Camera page */
    .topbar {
      position: absolute;
      top: 34px;
      left: 0;
      right: 0;
      padding: 10px var(--safe);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      z-index: 20;
      pointer-events: none;
    }

    .topbar>* {
      pointer-events: auto
    }

    .pillRow {
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(0, 0, 0, .25);
      border: 1px solid rgba(255, 255, 255, .12);
      padding: 6px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
    }

    .pill {
      border: 0;
      background: transparent;
      color: rgba(255, 255, 255, .8);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      transition: .15s ease;
      white-space: nowrap;
    }

    .pill.active {
      background: rgba(255, 255, 255, .16);
      color: rgba(255, 255, 255, .95);
    }

    .iconBtn {
      border: 0;
      background: rgba(0, 0, 0, .28);
      color: rgba(255, 255, 255, .9);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 999px;
      padding: 10px 12px;
      cursor: pointer;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      white-space: nowrap;
    }

    .iconBtn:active {
      transform: translateY(1px)
    }

    .cameraArea {
      position: absolute;
      inset: 0;
      background: #101116;
    }

    .preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: contrast(1.03) saturate(1.02) brightness(var(--exp, 1));
      transform: scale(var(--zoom, 1));
      transform-origin: 50% 50%;
      touch-action: none;
      background:
        radial-gradient(900px 600px at 30% 20%, rgba(255, 255, 255, .08), transparent 60%),
        radial-gradient(700px 500px at 70% 35%, rgba(255, 255, 255, .06), transparent 60%),
        linear-gradient(135deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
    }

    .warmupOverlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .45);
      z-index: 40;
      text-align: center;
      padding: 22px;
    }

    .warmupOverlay.show {
      display: flex
    }

    .warmupCard {
      width: min(320px, 90%);
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 22px;
      padding: 16px 14px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .25);
      backdrop-filter: blur(14px);
    }

    .warmupCard h3 {
      margin: 0 0 6px;
      font-size: 14px
    }

    .warmupCard p {
      margin: 0;
      font-size: 12px;
      color: var(--muted)
    }

    .spinner {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, .18);
      border-top-color: rgba(255, 255, 255, .8);
      margin: 10px auto 12px;
      animation: spin .9s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    /* Optional grid */
    .grid {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      transition: .15s ease;
      z-index: 5;
    }

    .grid.on {
      opacity: .35
    }

    .grid:before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        linear-gradient(to right, rgba(255, 255, 255, .35) 1px, transparent 1px) 33.33% 0 / 33.33% 100%,
        linear-gradient(to right, rgba(255, 255, 255, .35) 1px, transparent 1px) 66.66% 0 / 33.33% 100%,
        linear-gradient(to bottom, rgba(255, 255, 255, .35) 1px, transparent 1px) 33.33% 0 / 100% 33.33%,
        linear-gradient(to bottom, rgba(255, 255, 255, .35) 1px, transparent 1px) 66.66% 0 / 100% 33.33%;
    }

    /* Script card */
    .scriptCard {
      position: absolute;
      left: var(--safe);
      top: 46%;
      transform: translateY(-50%);
      width: min(210px, 54%);
      background: rgba(0, 0, 0, .35);
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 16px;
      padding: 10px 10px 10px;
      backdrop-filter: blur(12px);
      opacity: .60;
      z-index: 25;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }

    .scriptTitle {
      font-size: 11px;
      color: rgba(255, 255, 255, .75);
      margin-bottom: 6px;
      letter-spacing: .2px;
    }

    .scriptText {
      font-size: 14px;
      line-height: 1.25;
      color: rgba(255, 255, 255, .95);
    }

    /* Praise window â€” top-center */
    .praise {
      position: absolute;
      left: 50%;
      top: 112px;
      transform: translateX(-50%);
      width: calc(100% - (var(--safe) * 2));
      max-width: 360px;
      z-index: 22;
      display: none;
      gap: 10px;
      pointer-events: none;
    }

    .praise.show {
      display: flex
    }

    .praise>* {
      pointer-events: auto
    }

    .praiseCard {
      flex: 1;
      background: rgba(0, 0, 0, .30);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 18px;
      backdrop-filter: blur(12px);
      padding: 10px 10px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .25);
      overflow: hidden;
    }

    .praiseTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .praiseLine {
      font-size: 13px;
      color: rgba(255, 255, 255, .92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .praiseActions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 0 0 auto;
    }

    .miniBtn {
      border: 0;
      background: rgba(255, 255, 255, .12);
      color: rgba(255, 255, 255, .92);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .miniBtn.ghost {
      background: rgba(255, 255, 255, .08)
    }

    .miniBtn:active {
      transform: translateY(1px)
    }

    .praiseBody {
      margin-top: 10px;
      display: none;
      gap: 6px;
      flex-direction: column;
    }

    .praiseCard.expanded .praiseBody {
      display: flex
    }

    .praiseBody .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .08);
      font-size: 12px;
      color: rgba(255, 255, 255, .85);
    }

    .quietBadge {
      font-size: 11px;
      color: rgba(255, 255, 255, .7);
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 999px;
      padding: 7px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .quietBadge.on {
      background: rgba(255, 255, 255, .16);
      color: rgba(255, 255, 255, .92);
    }

    /* Bottom controls */
    .bottom {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px var(--safe) 18px;
      z-index: 30;
      background: linear-gradient(to top, rgba(0, 0, 0, .70), rgba(0, 0, 0, .10), transparent);
    }

    .filmstripWrap {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .filmstripWrap.show {
      display: flex
    }

    .filmstrip {
      flex: 1;
      display: flex;
      gap: 8px;
      overflow: auto;
      padding: 6px 2px;
      scrollbar-width: none;
    }

    .filmstrip::-webkit-scrollbar {
      display: none
    }

    .thumb {
      width: 58px;
      height: 58px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .14);
      overflow: hidden;
      position: relative;
      flex: 0 0 auto;
      cursor: pointer;
      background: rgba(255, 255, 255, .06);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      filter: contrast(1.03) saturate(1.02);
    }

    .thumb .badge {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 11px;
      background: rgba(0, 0, 0, .55);
      border: 1px solid rgba(255, 255, 255, .18);
      border-radius: 999px;
      padding: 4px 7px;
      color: rgba(255, 255, 255, .92);
      display: none;
    }

    .thumb.liked .badge {
      display: block
    }

    .thumb.failed {
      outline: 2px solid rgba(255, 77, 79, .9);
      outline-offset: 0px;
    }

    .thumb.failed:after {
      content: "!";
      position: absolute;
      left: 6px;
      top: 6px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 77, 79, .95);
      color: #fff;
      font-weight: 700;
      font-size: 12px;
    }

    .lightBtn {
      border: 0;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .12);
      color: rgba(255, 255, 255, .92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .lightBtn:active {
      transform: translateY(1px)
    }

    .lightBtn.primary {
      background: rgba(255, 255, 255, .18);
    }

    .lightBtn.hidden {
      display: none
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .shutter {
      width: 72px;
      height: 72px;
      border-radius: 999px;
      border: 3px solid rgba(255, 255, 255, .88);
      background: rgba(255, 255, 255, .14);
      cursor: pointer;
      position: relative;
      flex: 0 0 auto;
    }

    .shutter:before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .20);
    }

    .shutter[disabled] {
      opacity: .45;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .leftBtns,
    .rightBtns {
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 1;
    }

    .leftBtns {
      justify-content: flex-start
    }

    .rightBtns {
      justify-content: flex-end
    }

    /* Ref overlay â€” default LEFT-BOTTOM */
    .refOverlay {
      position: absolute;
      left: var(--safe);
      bottom: 210px;
      top: auto;
      right: auto;
      width: 132px;
      height: 176px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      z-index: 18;
      display: none;
      opacity: .50;
      touch-action: none;
      user-select: none;
    }

    .refOverlay.show {
      display: block
    }

    .refOverlay img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      /* è®©â€œæ•´å¼ å‚è€ƒå›¾â€éƒ½èƒ½ä½œä¸ºæ‹–åŠ¨çƒ­åŒºï¼šé¿å… img è‡ªå¸¦æ‹–æ‹½æŠ¢èµ°äº‹ä»¶ */
      pointer-events: none;
      -webkit-user-drag: none;
      user-drag: none;
    }

    .refTools {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 8px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      pointer-events: auto;
    }

    .refToolBtn {
      border: 0;
      background: rgba(0, 0, 0, .40);
      color: rgba(255, 255, 255, .92);
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }


    /* Thumbnail viewer (æ–°å¢ï¼šç‚¹å‡»ç¼©ç•¥å›¾å…ˆé¢„è§ˆå¤§å›¾å†é€‰ä¸­) */
    .viewerSheet {
      width: 100%;
      max-width: 420px;
      height: 58%;
      max-height: 520px;
      background: rgba(16, 16, 18, .92);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .viewerHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
      gap: 10px;
    }

    .viewerHeader .title {
      font-size: 14px;
      color: rgba(255, 255, 255, .92);
      font-weight: 650;
      letter-spacing: .2px;
      flex: 1;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }


    .viewerHeader .x {
      border: 0;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .12);
      color: rgba(255, 255, 255, .9);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }


    .viewerBody {
      flex: 1;
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .viewerFrame {
      flex: 1;
      border-radius: 18px;
      overflow: hidden;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }

    .viewerFrame img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }


    /* iOS Photos-like gestures (æ–°å¢ï¼šå·¦å³æ»‘åˆ‡æ¢ + åŒæŒ‡ç¼©æ”¾/æ‹–åŠ¨) */
    .viewerStage {
      position: absolute;
      inset: 0;
      overflow: hidden;
      border-radius: 18px;
      touch-action: none;
    }

    .viewerImgWrap {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      cursor: grab;
    }

    .viewerImgWrap.grabbing { cursor: grabbing; }

    #viewerImg {
      will-change: transform;
      pointer-events: none; /* æ‰‹åŠ¿ç»Ÿä¸€è½åœ¨ wrapper ä¸Š */
      transform: translate3d(0px, 0px, 0) scale(1);
      transform-origin: center center;
    }

    .viewerCounter {
      position: absolute;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, .35);
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, .85);
      backdrop-filter: blur(10px);
      user-select: none;
      pointer-events: none;
    }
    .viewerHint {
      font-size: 12px;
      color: rgba(255, 255, 255, .65);
      text-align: center;
      line-height: 1.35;
    }

    /* Sheets / modals */
    .modalBackdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 60;
      padding: 10px;
    }

    .modalBackdrop.show {
      display: flex
    }

    .sheet {
      width: 100%;
      max-width: 420px;
      background: rgba(20, 20, 22, .92);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      overflow: hidden;
    }

    .sheetHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
    }

    .sheetHeader .title {
      font-size: 14px;
      color: rgba(255, 255, 255, .92);
      font-weight: 650;
      letter-spacing: .2px;
    }

    .sheetHeader .x {
      border: 0;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .12);
      color: rgba(255, 255, 255, .9);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sheetBody {
      padding: 12px 14px 14px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .09);
    }

    .item .txt {
      font-size: 13px;
      color: rgba(255, 255, 255, .9);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .copyBtn {
      border: 0;
      background: rgba(255, 255, 255, .12);
      border: 1px solid rgba(255, 255, 255, .12);
      color: rgba(255, 255, 255, .92);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      flex: 0 0 auto;
    }

    .seg {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .seg button {
      border: 0;
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .10);
      color: rgba(255, 255, 255, .88);
      padding: 9px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
    }

    .seg button.active {
      background: rgba(255, 255, 255, .16);
      color: rgba(255, 255, 255, .95);
    }

    /* Permission blocking card */
    .centerModal {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 70;
      background: rgba(0, 0, 0, .58);
    }

    .centerModal.show {
      display: flex
    }

    .centerCard {
      width: min(360px, 92%);
      background: rgba(22, 22, 24, .92);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 16px 14px;
      backdrop-filter: blur(18px);
    }

    .centerCard h2 {
      margin: 0 0 8px;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .centerCard p {
      margin: 0 0 12px;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
    }

    .btnRow {
      display: flex;
      gap: 10px;
    }

    .btnRow .cta {
      flex: 1;
      border: 0;
      background: rgba(255, 255, 255, .18);
      border: 1px solid rgba(255, 255, 255, .14);
      color: rgba(255, 255, 255, .95);
      padding: 11px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-size: 13px;
    }

    .btnRow .cta.secondary {
      background: rgba(255, 255, 255, .08);
      color: rgba(255, 255, 255, .9);
    }

    .btnRow .cta.danger {
      background: rgba(255, 77, 79, .18);
      border-color: rgba(255, 77, 79, .22);
    }

    /* Wrap page */
    .wrapPage {
      position: absolute;
      inset: 0;
      display: none;
      z-index: 65;
      background: rgba(0, 0, 0, .62);
      backdrop-filter: blur(10px);
      padding: 16px 12px 14px;
    }

    .wrapPage.show {
      display: block
    }

    .wrapCard {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      top: 54px;
      background: rgba(22, 22, 24, .92);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .wrapHead {
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .wrapHead .title {
      font-size: 14px;
      font-weight: 700;
    }

    .wrapBody {
      padding: 12px 14px 14px;
      overflow: auto;
    }

    .stat {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .chip {
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .10);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255, 255, 255, .92);
      white-space: nowrap;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin: 6px 0 10px;
      line-height: 1.35;
    }

    .grid3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .pick {
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .12);
      overflow: hidden;
      cursor: pointer;
      background: rgba(255, 255, 255, .06);
      position: relative;
    }

    .pick img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .pick.selected {
      outline: 2px solid rgba(255, 255, 255, .85)
    }

    .pick .selBadge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, .55);
      border: 1px solid rgba(255, 255, 255, .18);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: rgba(255, 255, 255, .92);
    }

    .collageBox {
      margin-top: 12px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .04);
      border-radius: 18px;
      overflow: hidden;
      padding: 10px;
    }

    .collageRow {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    canvas#collage {
      width: 210px;
      height: 372px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .25);
    }

    .wrapBtns {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .wrapBtns button {
      border: 0;
      cursor: pointer;
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 13px;
      color: rgba(255, 255, 255, .95);
      background: rgba(255, 255, 255, .14);
      border: 1px solid rgba(255, 255, 255, .12);
      flex: 1 1 120px;
    }

    .wrapBtns button.secondary {
      background: rgba(255, 255, 255, .08);
    }

    .wrapBtns button.primary {
      background: rgba(255, 255, 255, .18);
    }

    .inputRow {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .inputRow input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .92);
      outline: none;
    }

    .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    /* Toast */
    .toast {
      position: absolute;
      left: 50%;
      bottom: 98px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, .65);
      border: 1px solid rgba(255, 255, 255, .14);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12px;
      color: rgba(255, 255, 255, .92);
      z-index: 100;
      display: none;
      white-space: nowrap;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
      backdrop-filter: blur(12px);
    }

    .toast.show {
      display: block
    }

    .flash {
      animation: flash .55s ease;
    }

    @keyframes flash {
      0% {
        filter: brightness(1)
      }

      40% {
        filter: brightness(1.35)
      }

      100% {
        filter: brightness(1)
      }
    }

    .pulse {
      animation: pulse 1.1s ease-in-out 1;
    }

    @keyframes pulse {
      0% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.06)
      }

      100% {
        transform: scale(1)
      }
    }

    .hintPanel {
      width: 340px;
      max-width: 92vw;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 22px;
      padding: 14px 14px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, .35);
      color: rgba(255, 255, 255, .86);
    }

    .hintPanel h3 {
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: .2px;
    }

    .hintPanel p {
      margin: 0 0 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, .72);
      line-height: 1.4;
    }

    .kbd {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(0, 0, 0, .22);
      font-size: 11px;
      color: rgba(255, 255, 255, .85);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="phone" id="phone">
      <div class="statusbar">
        <span>Just Photo</span>
        <span id="clock">--:--</span>
      </div>

      <div class="screen active" id="screenCamera">
        <div class="cameraArea">
          <video class="preview" id="video" autoplay playsinline muted></video>
          <div class="preview" id="fallbackPreview" style="display:none;"></div>
          <div class="grid" id="grid"></div>

          <div class="warmupOverlay" id="warmup">
            <div class="warmupCard">
              <div class="spinner"></div>
              <h3>ç›¸æœºé¢„çƒ­ä¸­â€¦</h3>
              <p>ç›®æ ‡ï¼šå†·å¯åŠ¨è¿›å…¥æ‹æ‘„é¡µå¿«é—¨å¯ç‚¹ â‰¤ 3 ç§’</p>
            </div>
          </div>

          <!-- Top bar -->
          <div class="topbar">
            <!-- å·¦ä¸Šï¼šé—ªå…‰ç¯ + å¤¸å¤¸/åœºæ™¯/æ²¡çµæ„Ÿ -->
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="iconBtn" id="btnFlash" title="é—ªå…‰ç¯">âš¡ï¸ è‡ªåŠ¨</button>
              <div class="pillRow" aria-label="top actions">
                <button class="pill" id="btnPraise">å¤¸å¤¸</button>
                <button class="pill active" id="btnSceneToggle">å’–å•¡å…</button>
                <button class="pill" id="btnInspo">æ²¡çµæ„Ÿï¼Ÿ</button>
              </div>
            </div>

            <!-- å³ä¸Šï¼šç›¸æœºç¿»è½¬ + è®¾ç½® -->
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="iconBtn" id="btnReset" title="é‡ç½®å¯¹è¯">é‡ç½®</button>
              <button class="iconBtn" id="btnSettings" title="è®¾ç½®">âš™ï¸</button>
            </div>
          </div>

          <!-- Script card -->
          <div class="scriptCard" id="scriptCard">
            <div class="scriptTitle">å°è¯å¡ï¼ˆç»™æ‹æ‘„è€…ï¼‰</div>
            <div class="scriptText" id="scriptText">è¯·å¯¹å¥¹è¯´ï¼šçœ‹æˆ‘</div>
          </div>

          <!-- Ref overlay -->
          <div class="refOverlay" id="refOverlay">
            <img id="refImg" alt="reference" />
            <div class="refTools">
              <button class="refToolBtn" id="refSize">å¤§</button>
              <button class="refToolBtn" id="refHide">éšè—</button>
            </div>
          </div>

          <!-- Praise -->
          <div class="praise" id="praiseWrap">
            <div class="praiseCard" id="praiseCard">
              <div class="praiseTop">
                <div class="praiseLine" id="praiseLine">å¾ˆå¥½ï¼å°±è¿™æ ·</div>
                <div class="praiseActions">
                  <button class="miniBtn ghost" id="btnThumbUp" title="å–œæ¬¢è¿™æ¡">ğŸ‘</button>
                  <button class="miniBtn ghost" id="btnThumbDown" title="ä¸å–œæ¬¢è¿™æ¡">ğŸ‘</button>
                  <button class="miniBtn" id="btnExpand">å±•å¼€</button>
                  <div class="quietBadge" id="quietToggle" title="å®‰é™æ¨¡å¼">å®‰é™</div>
                </div>
              </div>
              <div class="praiseBody" id="praiseBody"></div>
            </div>
          </div>

          <!-- Bottom controls -->
          <div class="bottom">
            <div class="filmstripWrap" id="filmstripWrap">
              <div class="filmstrip" id="filmstrip"></div>
              <button class="lightBtn hidden" id="btnNoGood">æ²¡æ»¡æ„ç…§ç‰‡</button>
              <button class="lightBtn primary hidden" id="btnWrap">æ”¶å·¥</button>
            </div>

            <div class="controls">
              <!-- å·¦ä¸‹ï¼šå‚è€ƒå›¾ï¼ˆç¬¬ä¸€ä¸ªï¼‰ + ç›¸å†Œï¼ˆç¬¬äºŒä¸ªï¼‰ -->
              <div class="leftBtns">
                <button class="lightBtn" id="btnAddRef">å‚è€ƒå›¾</button>
                <button class="lightBtn" id="btnOpenAlbum">ç›¸å†Œ</button>
              </div>

              <button class="shutter" id="shutter" disabled aria-label="shutter"></button>

              <div class="rightBtns">
                <button class="lightBtn" id="btnFlip">ç¿»è½¬</button>
              </div>

            </div>
          </div>


          <!-- Exposure HUD (æ–°å¢) -->
          <div id="focusBox" style="
            position:absolute; width:74px; height:74px;
            border:2px solid rgba(255,255,255,.75);
            border-radius:14px; display:none; z-index:55;
            pointer-events:none;
          "></div>

          <div id="expHud" style="
            position:absolute; display:none; z-index:56;
            background:rgba(0,0,0,.45);
            border:1px solid rgba(255,255,255,.14);
            border-radius:16px;
            padding:10px 10px;
            backdrop-filter: blur(12px);
          ">
            <div style="font-size:12px; color:rgba(255,255,255,.85); margin-bottom:8px;">æ›å…‰</div>
            <div style="display:flex; align-items:center; gap:10px;">
              <div style="font-size:16px;">â˜€ï¸</div>
              <input id="expRange" type="range" min="-2" max="2" step="0.1" value="0" style="width:140px;" />
            </div>
          </div>

          <div class="toast" id="toast">Toast</div>

          <!-- Permission flow (blocking) -->
          <div class="centerModal show" id="permModal">
            <div class="centerCard" id="permCard">
              <h2 id="permTitle">éœ€è¦ç›¸å†Œæƒé™æ‰èƒ½ä½¿ç”¨</h2>
              <p id="permDesc">Just Photo ä¼šæŠŠä½ æ‹çš„ç…§ç‰‡ä¿å­˜åˆ°ç³»ç»Ÿç›¸å†Œï¼Œå¹¶å†™å…¥ã€ŒJust Photoã€ä¸“å±ç›¸å†Œï¼ˆä¸ä¼šä¸Šä¼ ï¼‰ã€‚</p>
              <div class="btnRow" id="permButtons">
                <button class="cta secondary" id="permExit">é€€å‡º</button>
                <button class="cta" id="permContinue">ç»§ç»­</button>
              </div>
            </div>
          </div>


          <!-- Reset confirm (æ–°å¢) -->
          <div class="centerModal" id="resetModal">
            <div class="centerCard">
              <h2>ç¡®å®šè¦é‡ç½®æœ¬è½®å¯¹è¯ï¼Ÿ</h2>
              <p>å°†æ¸…ç©ºæœ¬è½®æ‹æ‘„çš„ç¼©ç•¥å›¾ã€âœ…æ ‡è®°ã€åœ°ç‚¹ä¸æ‹¼å›¾é€‰æ‹©ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
              <div class="btnRow">
                <button class="cta secondary" id="resetCancel">å–æ¶ˆ</button>
                <button class="cta danger" id="resetConfirm">é‡ç½®</button>
              </div>
            </div>
          </div>

          <!-- Sheet: Inspiration -->
          <div class="modalBackdrop" id="sheetInspo">
            <div class="sheet" role="dialog" aria-modal="true">
              <div class="sheetHeader">
                <button class="x" id="closeInspo">Ã—</button>
                <div class="title">æ²¡çµæ„Ÿï¼Ÿ</div>
                <div style="width:34px"></div>
              </div>
              <div class="sheetBody">
                <div class="list" id="inspoList"></div>
                <p style="margin:12px 2px 0; font-size:12px; color:rgba(255,255,255,.65);">
                  å¤åˆ¶åä½ å¯ä»¥è‡ªè¡Œå» IG / TikTok / å°çº¢ä¹¦æœç´¢ï¼ˆä¸å†…è·³å¹³å°ï¼‰ã€‚
                </p>
              </div>
            </div>
          </div>

          <!-- Sheet: Settings -->
          <div class="modalBackdrop" id="sheetSettings">
            <div class="sheet" role="dialog" aria-modal="true">
              <div class="sheetHeader">
                <button class="x" id="closeSettings">Ã—</button>
                <div class="title">è®¾ç½®</div>
                <div style="width:34px"></div>
              </div>
              <div class="sheetBody">
                <div class="item">
                  <div class="txt">æ„å›¾ç½‘æ ¼çº¿</div>
                  <button class="copyBtn" id="toggleGrid">å¼€/å…³</button>
                </div>

                <div class="item">
                  <div class="txt">ç…§ç‰‡è¯»å–èŒƒå›´</div>
                  <div class="seg">
                    <button id="scopeJP" class="active">ä»… Just Photo</button>
                    <button id="scopeFull">å…¨éƒ¨ç…§ç‰‡</button>
                  </div>
                </div>

                <div class="item">
                  <div class="txt">æ·»åŠ åˆ° Just Photo</div>
                  <button class="copyBtn" id="btnImport">é€‰å›¾å½’æ¡£</button>
                </div>

                <div class="item">
                  <div class="txt">ç®¡ç†ç…§ç‰‡æƒé™</div>
                  <button class="copyBtn" id="btnGoSettings">å»ç³»ç»Ÿè®¾ç½®</button>
                </div>

                <p style="margin:12px 2px 0; font-size:12px; color:rgba(255,255,255,.65); line-height:1.35;">
                  è¯´æ˜ï¼šè¿™æ˜¯çº¯å‰ç«¯åŸå‹ï¼Œç³»ç»Ÿç›¸å†Œ/æƒé™å†™å…¥å‡ä¸ºâ€œæ¨¡æ‹Ÿâ€ï¼Œç”¨äºéªŒè¯äº¤äº’èŠ‚å¥ä¸é£æ§æç¤ºã€‚
                </p>

                <input id="fileRef" type="file" accept="image/*" style="display:none" />
                <input id="fileImport" type="file" accept="image/*" multiple style="display:none" />
              </div>
            </div>
          </div>


          <!-- Viewer: Filmstrip thumbnail preview (æ–°å¢) -->
          <div class="modalBackdrop" id="thumbViewer">
            <div class="viewerSheet" role="dialog" aria-modal="true">
              <div class="viewerHeader">
                <button class="x" id="viewerClose">Ã—</button>
                <div class="title" id="viewerTitle">é¢„è§ˆ</div>
                <button class="copyBtn" id="viewerToggle">âœ… é€‰ä¸­</button>
              </div>
              <div class="viewerBody">
                <div class="viewerFrame">
                  <div class="viewerStage" id="viewerStage">
                    <div class="viewerImgWrap" id="viewerImgWrap">
                      <img id="viewerImg" alt="preview" draggable="false" />
                    </div>
                    <div class="viewerCounter" id="viewerCounter">1 / 1</div>
                  </div>
                </div>
                <div class="viewerHint">æ‰‹åŠ¿ï¼šå·¦å³æ»‘åˆ‡æ¢ï¼›åŒå‡»æ”¾å¤§/å¤ä½ï¼›åŒæŒ‡ç¼©æ”¾ï¼‹æ‹–åŠ¨ç”»é¢ï¼ˆç¼©æ”¾æ—¶ä¼šé”å®šç¿»é¡µï¼Œå’Œ iOS ç›¸å†Œä¸€è‡´ï¼‰ã€‚</div>
                </div>
            </div>
          </div>

          <!-- Wrap page -->
          <div class="wrapPage" id="wrapPage">
            <div class="wrapHead" style="position:absolute; left:12px; right:12px; top: 10px;">
              <div class="title">æ”¶å·¥</div>
              <button class="x" id="closeWrap" style="width:38px;height:38px;">Ã—</button>
            </div>
            <div class="wrapCard">
              <div class="wrapHead">
                <div class="title">æœ¬è½®ç»“æŸæ„Ÿ + æ‹¼å›¾äº§å‡º</div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <span class="chip" id="scopeChip">è¯»å–ï¼šä»… Just Photo</span>
                </div>
              </div>
              <div class="wrapBody">
                <div class="stat">
                  <div class="chip" id="statShots">æœ¬è½®æ‹äº† 0 å¼ </div>
                  <div class="chip" id="statLiked">æ ‡è®°äº† 0 å¼ </div>
                </div>

                <div class="hint">å¿«é€ŸæŒ‘é€‰ï¼ˆæœ€å¤š 3 å¼ ï¼‰ã€‚ä¼˜å…ˆ âœ… æ ‡è®°ï¼›è‹¥æ—  âœ… é»˜è®¤å–æœ€å 3 å¼ ã€‚</div>

                <div class="grid3" id="pickGrid"></div>

                <div class="inputRow">
                  <input id="locationInput" placeholder="åœ°ç‚¹ï¼ˆå¯é€‰ï¼‰ä¾‹å¦‚ï¼šGuangzhou / Tokyo" />
                  <button class="copyBtn" id="btnApplyLocation">åº”ç”¨</button>
                </div>

                <div class="collageBox">
                  <div class="collageRow">
                    <canvas id="collage" width="900" height="1600"></canvas>
                    <div style="flex:1; min-width: 160px;">
                      <div class="hint" style="margin-top:0">
                        äº§ç‰©ï¼š9:16 Story é•¿å›¾ï½œé»˜è®¤ 3-upï½œæ—¥æœŸï¼ˆå¿…ï¼‰+ åœ°ç‚¹ï¼ˆå¯é€‰ï¼‰+ å“ç‰Œè§’æ ‡ï¼ˆå…‹åˆ¶ï¼‰ã€‚
                      </div>
                      <div class="wrapBtns">
                        <button class="primary" id="btnSaveCollage">ä¿å­˜æ‹¼å›¾</button>
                        <button class="secondary" id="btnShareCollage">åˆ†äº«åˆ°â€¦</button>
                        <button class="secondary" id="btnAlbumFromWrap">æ‰“å¼€ç³»ç»Ÿç›¸å†Œ</button>
                        <button class="secondary" id="btnContinueShoot">ç»§ç»­æ‹</button>
                      </div>
                      <div class="note">æç¤ºï¼šè¿™å¼ æ‹¼å›¾ä¸ä¼šä¿®æ”¹ä½ çš„åŸç‰‡ã€‚</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <canvas id="cap" width="480" height="640" style="display:none;"></canvas>
        </div>
      </div>
    </div>

    <div class="hintPanel">
      <h3>æœ¬æ¬¡æ”¹åŠ¨ï¼ˆä¸åŠ¨äº¤äº’ï¼‰</h3>
      <p>â€¢ å·¦ä¸‹ï¼šå‚è€ƒå›¾ï¼ˆç¬¬ä¸€ä¸ªï¼‰/ ç›¸å†Œï¼ˆç¬¬äºŒä¸ªï¼‰</p>
      <p>â€¢ å³ä¸Šï¼šç›¸æœºç¿»è½¬ï¼ˆå‰ç½®=é»˜è®¤åªå¤¸å¤¸ï¼Œä¸æ˜¾ç¤ºæç¤ºè¯ï¼‰</p>
      <p>â€¢ å·¦ä¸Šï¼šé—ªå…‰ç¯ï¼ˆè‡ªåŠ¨/å¼€/å…³ï¼‰</p>
      <p>æç¤ºï¼šä¸ºä½¿ç”¨ç›¸æœºé¢„è§ˆï¼Œå»ºè®®ç”¨ <span class="kbd">http://localhost</span> æ‰“å¼€è€Œä¸æ˜¯ file://ã€‚</p>
    </div>
  </div>

  <script>
    (() => {
      const $ = (sel, el = document) => el.querySelector(sel);
      const $$ = (sel, el = document) => [...el.querySelectorAll(sel)];
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const now = () => new Date();
      const fmtTime = (d) => String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      const toastEl = $('#toast');
      let toastTimer = null;
      function toast(msg, ms = 1400) {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), ms);
      }

      // ---------- Clock ----------
      const clockEl = $('#clock');
      setInterval(() => clockEl.textContent = fmtTime(now()), 500);
      clockEl.textContent = fmtTime(now());

      // ---------- State ----------
      const State = {
        perm: { granted: false, denied: false, scope: 'jp' },
        scene: 'cafe',
        s: 'S0',
        warm: false,
        quiet: false,
        grid: false,
        albumOk: true,
        cameraFacing: 'environment', // environment | user
        flashMode: 'auto', // auto | on | off
        session: {
          photos: [],
          usedKeywords: { cafe: [], outdoor: [] },
          usedPrompts: { cafe: [], outdoor: [] },
          usedPraise: { cafe: [], outdoor: [] },
          location: ''
        }
      };

      // ---------- Pools ----------
      const PROMPTS = {
        cafe: [
          "è¯·å¯¹å¥¹è¯´ï¼šçœ‹æˆ‘", "è¯·å¯¹å¥¹è¯´ï¼šåˆ«åŠ¨", "è¯·å¯¹å¥¹è¯´ï¼šåœä¸€ä¸‹", "è¯·å¯¹å¥¹è¯´ï¼šçœ‹å…‰",
          "è¯·å¯¹å¥¹è¯´ï¼šä¸‹å·´å¾®æŠ¬ä¸€ç‚¹", "è¯·å¯¹å¥¹è¯´ï¼šè‚©æ”¾æ¾", "è¯·å¯¹å¥¹è¯´ï¼šå¾€çª—è¾¹é åŠæ­¥",
          "è¯·å¯¹å¥¹è¯´ï¼šçœ¼ç›çœ‹æˆ‘ä¸‰ç§’", "è¯·å¯¹å¥¹è¯´ï¼šæ…¢æ…¢å‘¼æ°”", "è¯·å¯¹å¥¹è¯´ï¼šæ‰‹è‡ªç„¶å‚ä¸‹",
          "è¯·å¯¹å¥¹è¯´ï¼šä¸Šèº«å¾®è½¬ä¸€ç‚¹", "è¯·å¯¹å¥¹è¯´ï¼šé è¿‘æˆ‘ä¸€ç‚¹ç‚¹"
        ],
        outdoor: [
          "è¯·å¯¹å¥¹è¯´ï¼šçœ‹æˆ‘", "è¯·å¯¹å¥¹è¯´ï¼šåˆ«åŠ¨", "è¯·å¯¹å¥¹è¯´ï¼šåœä¸€ä¸‹", "è¯·å¯¹å¥¹è¯´ï¼šçœ‹å…‰",
          "è¯·å¯¹å¥¹è¯´ï¼šå¾€å·¦ä¸€ç‚¹", "è¯·å¯¹å¥¹è¯´ï¼šå°±è¿™æ ·ï¼Œæ‹", "è¯·å¯¹å¥¹è¯´ï¼šç«™ç¨³åˆ«æ™ƒ",
          "è¯·å¯¹å¥¹è¯´ï¼šæŠ¬å¤´ä¸€ç‚¹ç‚¹", "è¯·å¯¹å¥¹è¯´ï¼šæ…¢æ…¢èµ°ä¸¤æ­¥", "è¯·å¯¹å¥¹è¯´ï¼šåœåœ¨é‚£å„¿",
          "è¯·å¯¹å¥¹è¯´ï¼šèº«ä½“å¾®ä¾§", "è¯·å¯¹å¥¹è¯´ï¼šçœ‹è¿œå¤„ä¸€ç§’"
        ]
      };
      const PRAISE = {
        cafe: [
          "å¾ˆå¥½ï¼å°±è¿™æ ·", "å¾ˆè‡ªç„¶", "å…‰å¥½æ¼‚äº®", "è¿™ä¸ªè§’åº¦å¾ˆæ£’",
          "ä½ çš„çŠ¶æ€å¾ˆæ¾å¼›", "å¥½çœ‹ï¼ä¿æŒ", "è¿™å¼ å¾ˆæœ‰æ°›å›´",
          "å¤ªé€‚åˆè¿™ä¸ªå…‰äº†", "è¡¨æƒ…ç‰¹åˆ«å¹²å‡€", "åˆšåˆšé‚£ä¸€ä¸‹å¾ˆæ£’",
          "å¾ˆæœ‰ç”µå½±æ„Ÿ", "è¶…çº§ä¸Šé•œ"
        ],
        outdoor: [
          "å¾ˆå¥½ï¼å°±è¿™æ ·", "å¾ˆè‡ªç„¶", "å…‰å¥½æ¼‚äº®", "è¿™ä¸ªè§’åº¦å¾ˆæ£’",
          "ä½ ç«™åœ¨è¿™é‡Œå¤ªåˆé€‚äº†", "è¿™å¼ å¾ˆåƒæ—…è¡Œå¤§ç‰‡", "å¤ªæœ‰æ°”è´¨äº†",
          "åŠ¨ä½œåˆšåˆšå¥½", "ä½ çœ‹èµ·æ¥å¾ˆæ”¾æ¾", "è¿™å¼ ç‰¹åˆ«é«˜çº§",
          "å¤ªä¸Šé•œäº†", "ä½ ç¬‘ä¸€ä¸‹ä¼šæ›´ç»"
        ]
      };
      const INSPO = {
        cafe: [
          "window light", "cafe portrait", "coffee pose", "bar counter vibe", "film look",
          "soft mood", "candid smile", "hands on cup", "looking out window", "minimal outfit",
          "close-up portrait", "shadow pattern", "warm tone", "table corner", "espresso moment",
          "mirror reflection", "seat by window", "soft grain", "quiet aesthetic", "street cafe"
        ],
        outdoor: [
          "landmark portrait", "travel photo", "natural pose", "walk toward camera", "backlight glow",
          "wide angle portrait", "street candid", "look over shoulder", "sun flare", "city skyline",
          "steps pose", "hand in pocket", "wind hair", "architectural lines", "leading lines",
          "golden hour", "tourist vibe", "minimal travel", "street shadow", "bridge shot"
        ]
      };
      const DOWN_REASONS = ["å¤ªç”œ", "å¤ªå°¬", "å¤ªå‘½ä»¤", "ä¸ç¬¦åˆåœºæ™¯", "åƒåœ¨è¯„ä»·æˆ‘"];

      // ---------- DOM ----------
      const warmup = $('#warmup');
      const shutter = $('#shutter');
      const filmstripWrap = $('#filmstripWrap');
      const filmstrip = $('#filmstrip');
      const btnWrap = $('#btnWrap');
      const btnNoGood = $('#btnNoGood');

      // Thumbnail viewer (æ–°å¢)
      const thumbViewer = $('#thumbViewer');
      const viewerImg = $('#viewerImg');
      const viewerClose = $('#viewerClose');
      const viewerToggle = $('#viewerToggle');
      const viewerTitle = $('#viewerTitle');
      const viewerStage = $('#viewerStage');
      const viewerImgWrap = $('#viewerImgWrap');
      const viewerCounter = $('#viewerCounter');


      const scriptCard = $('#scriptCard');
      const scriptText = $('#scriptText');

      const grid = $('#grid');

      const video = $('#video');
      const fallbackPreview = $('#fallbackPreview');
      const cap = $('#cap');
      const capCtx = cap.getContext('2d', { willReadFrequently: true });

      // Praise
      const praiseWrap = $('#praiseWrap');
      const praiseCard = $('#praiseCard');
      const praiseLine = $('#praiseLine');
      const praiseBody = $('#praiseBody');
      const quietToggle = $('#quietToggle');

      // Buttons
      const btnPraise = $('#btnPraise');
      const btnSceneToggle = $('#btnSceneToggle');
      const btnInspo = $('#btnInspo');
      const btnFlash = $('#btnFlash');
      const btnReset = $('#btnReset');

      // Bottom-left (moved)
      const btnAddRef = $('#btnAddRef');
      const btnOpenAlbum = $('#btnOpenAlbum');

      // ---------- LRU ----------
      function pickLRU(pool, usedArr, n = 5) {
        const recent = new Set(usedArr.slice(-n));
        const candidates = pool.filter(x => !recent.has(x));
        const src = candidates.length ? candidates : pool;
        const pick = src[Math.floor(Math.random() * src.length)];
        usedArr.push(pick);
        if (usedArr.length > 80) usedArr.splice(0, usedArr.length - 80);
        return pick;
      }
      function setNewPrompt() {
        const txt = pickLRU(PROMPTS[State.scene], State.session.usedPrompts[State.scene], 6);
        scriptText.textContent = txt;
      }
      function setNewPraise() {
        const txt = pickLRU(PRAISE[State.scene], State.session.usedPraise[State.scene], 6);
        praiseLine.textContent = txt;
      }
      function renderPraiseBody() {
        praiseBody.innerHTML = "";
        const lines = [];
        for (let i = 0; i < 4; i++) {
          lines.push(pickLRU(PRAISE[State.scene], State.session.usedPraise[State.scene], 6));
        }
        lines.forEach(line => {
          const row = document.createElement('div');
          row.className = 'row';
          row.innerHTML = `<span>${line}</span><span style="color:rgba(255,255,255,.55); font-size:11px;">ç»™è¢«æ‹è€…</span>`;
          praiseBody.appendChild(row);
        });
      }

      // ---------- è‡ªæ‹æ¨¡å¼ï¼šé»˜è®¤åªå¤¸å¤¸ï¼Œä¸æç¤ºè¯ ----------
      let praiseOpen = false;
      function updatePromptVisibilityForFacing() {
        const selfie = (State.cameraFacing === 'user');
        scriptCard.style.display = selfie ? 'none' : '';
        // è‡ªæ‹ï¼šé»˜è®¤è®©å¤¸å¤¸æ˜¾ç¤ºï¼ˆé™¤éç”¨æˆ·å¼€äº†å®‰é™ï¼‰
        if (selfie && !State.quiet) {
          praiseOpen = true;
        }
        updatePraiseVisibility();
      }
      function updatePraiseVisibility() {
        if (State.quiet) {
          praiseWrap.classList.remove('show');
          btnPraise.classList.remove('active');
          return;
        }
        praiseWrap.classList.toggle('show', praiseOpen);
        btnPraise.classList.toggle('active', praiseOpen);
      }

      btnPraise.onclick = () => {
        praiseOpen = !praiseOpen;
        updatePraiseVisibility();
        toast(praiseOpen ? "å¤¸å¤¸ï¼šå·²æ‰“å¼€" : "å¤¸å¤¸ï¼šå·²æ”¶èµ·");
      };

      // ---------- Quiet mode ----------
      quietToggle.onclick = () => {
        State.quiet = !State.quiet;
        quietToggle.classList.toggle('on', State.quiet);
        updatePraiseVisibility();
        toast(State.quiet ? "å®‰é™æ¨¡å¼ï¼šå·²éšè—å¤¸å¤¸" : "å®‰é™æ¨¡å¼ï¼šå·²å…³é—­");
      };

      // Praise interactions
      $('#btnExpand').onclick = () => {
        praiseCard.classList.toggle('expanded');
        if (praiseCard.classList.contains('expanded')) {
          renderPraiseBody();
          toast("å¤¸å¤¸ï¼šå±•å¼€");
        } else {
          toast("å¤¸å¤¸ï¼šæ”¶èµ·");
        }
      };
      $('#btnThumbUp').onclick = () => { setNewPraise(); toast("ğŸ‘ å·²æ¢ä¸€æ¡"); };
      $('#btnThumbDown').onclick = async () => { setNewPraise(); toast("ğŸ‘ å·²æ¢ä¸€æ¡"); await sleep(250); showReasons(); };

      function showReasons() {
        const sheet = document.createElement('div');
        sheet.style.position = 'absolute';
        sheet.style.left = '14px';
        sheet.style.right = '14px';
        sheet.style.top = '180px';
        sheet.style.zIndex = 80;
        sheet.innerHTML = `
      <div style="background:rgba(20,20,24,.92); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:10px; backdrop-filter:blur(14px);">
        <div style="font-size:12px; color:rgba(255,255,255,.85); margin-bottom:8px;">ä¸å–œæ¬¢çš„åŸå› ï¼ˆå•é€‰ï¼‰</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          ${DOWN_REASONS.map(r => `<button data-r="${r}" style="border:0; cursor:pointer; padding:9px 10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); color:rgba(255,255,255,.88); font-size:12px;">${r}</button>`).join('')}
        </div>
      </div>
    `;
        $('#phone').appendChild(sheet);
        $$('button', sheet).forEach(btn => {
          btn.onclick = () => { toast("åŸå› ï¼š" + btn.dataset.r); sheet.remove(); };
        });
        setTimeout(() => sheet.remove(), 2200);
      }

      // ---------- Scene toggle ----------
      function setScene(scene) {
        State.scene = scene;
        btnSceneToggle.textContent = (scene === 'cafe') ? 'å’–å•¡å…' : 'æˆ·å¤–åœ°æ ‡';
        btnSceneToggle.classList.add('active');

        setNewPrompt();
        setNewPraise();
        if (praiseCard.classList.contains('expanded')) renderPraiseBody();
        updatePromptVisibilityForFacing();

        toast(scene === 'cafe' ? "åœºæ™¯ï¼šå’–å•¡å…" : "åœºæ™¯ï¼šæˆ·å¤–åœ°æ ‡");
      }
      btnSceneToggle.onclick = () => {
        const next = (State.scene === 'cafe') ? 'outdoor' : 'cafe';
        setScene(next);
      };

      // ---------- Flash (3 states) ----------
      function renderFlashBtn() {
        const label = State.flashMode === 'auto' ? 'âš¡ï¸ è‡ªåŠ¨' : (State.flashMode === 'on' ? 'âš¡ï¸ å¼€' : 'âš¡ï¸ å…³');
        btnFlash.textContent = label;
      }
      btnFlash.onclick = () => {
        State.flashMode = (State.flashMode === 'auto') ? 'on' : (State.flashMode === 'on' ? 'off' : 'auto');
        renderFlashBtn();
        toast("é—ªå…‰ç¯ï¼š" + (State.flashMode === 'auto' ? 'è‡ªåŠ¨' : (State.flashMode === 'on' ? 'å¼€' : 'å…³')));
      };
      renderFlashBtn();

      // ---------- Camera flip ----------
      function stopStream() {
        const s = video.srcObject;
        if (s && s.getTracks) {
          s.getTracks().forEach(t => t.stop());
        }
        video.srcObject = null;
      }
      async function restartCameraForFacing() {
        // file:// fallback
        if (!(location.protocol === 'https:' || location.hostname === 'localhost')) {
          toast("å»ºè®®ç”¨ localhost æ‰“å¼€ä»¥å¯ç”¨ç›¸æœºï¼ˆå½“å‰ä¸ºå ä½é¢„è§ˆï¼‰");
          return;
        }
        shutter.disabled = true;
        toast("åˆ‡æ¢ç›¸æœºâ€¦");
        try {
          stopStream();
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: State.cameraFacing },
            audio: false
          });
          video.srcObject = stream;
          video.style.display = '';
          fallbackPreview.style.display = 'none';
          await sleep(220);
          shutter.disabled = false;
          toast(State.cameraFacing === 'user' ? "å·²åˆ‡åˆ°å‰ç½®ï¼ˆåªå¤¸å¤¸ï¼‰" : "å·²åˆ‡åˆ°åç½®");
        } catch (e) {
          // revert if fail
          State.cameraFacing = (State.cameraFacing === 'user') ? 'environment' : 'user';
          toast("åˆ‡æ¢å¤±è´¥ï¼ˆæƒé™/è®¾å¤‡ä¸æ”¯æŒï¼‰");
          shutter.disabled = false;
        }
        updatePromptVisibilityForFacing();
      }
      // ========== Reset confirm (æ–°å¢) ==========
      const resetModal = document.getElementById('resetModal');
      const resetCancel = document.getElementById('resetCancel');
      const resetConfirm = document.getElementById('resetConfirm');

      // Dummy functions for missing dependencies
      // ========== Zoom (æ–°å¢) ==========
      State.zoom = 1;

      const cameraAreaEl = document.querySelector('.cameraArea');
      function setZoom(z) {
        State.zoom = Math.max(1, Math.min(4, z));
        cameraAreaEl && cameraAreaEl.style.setProperty('--zoom', State.zoom.toFixed(2));
      }

      // åŒæŒ‡ pinch
      const pointers = new Map();
      let pinchStart = null;

      function isOnUI(target) {
        return !!target.closest('.topbar, .bottom, .praise, .scriptCard, .refOverlay, .modalBackdrop, .wrapPage, .centerModal');
      }
      function dist(a, b) {
        const dx = a.x - b.x, dy = a.y - b.y;
        return Math.hypot(dx, dy);
      }

      cameraAreaEl && cameraAreaEl.addEventListener('pointerdown', (e) => {
        if (isOnUI(e.target)) return;
        pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

        if (pointers.size === 2) {
          const pts = [...pointers.values()];
          pinchStart = { d: dist(pts[0], pts[1]), z: State.zoom };
        }
      });

      cameraAreaEl && cameraAreaEl.addEventListener('pointermove', (e) => {
        if (!pointers.has(e.pointerId)) return;
        pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

        if (pinchStart && pointers.size === 2) {
          const pts = [...pointers.values()];
          const d = dist(pts[0], pts[1]);
          const next = pinchStart.z * (d / pinchStart.d);
          setZoom(next);
        }
      });

      function endPointer(e) {
        pointers.delete(e.pointerId);
        if (pointers.size < 2) pinchStart = null;
      }
      cameraAreaEl && cameraAreaEl.addEventListener('pointerup', endPointer);
      cameraAreaEl && cameraAreaEl.addEventListener('pointercancel', endPointer);

      // å¯é€‰ï¼šæ»šè½®/è§¦æ§æ¿ç¼©æ”¾ï¼ˆMac å¾ˆå¥½ç”¨ï¼‰
      cameraAreaEl && cameraAreaEl.addEventListener('wheel', (e) => {
        if (isOnUI(e.target)) return;
        e.preventDefault();
        const delta = (e.deltaY > 0 ? -0.08 : 0.08);
        setZoom(State.zoom + delta);
      }, { passive: false });



      // ========== Exposure (æ–°å¢) ==========
      State.expEV = 0;

      const focusBox = document.getElementById('focusBox');
      const expHud = document.getElementById('expHud');
      const expRange = document.getElementById('expRange');

      function setExposureEV(ev) {
        State.expEV = Math.max(-2, Math.min(2, ev));
        // EV æ˜ å°„åˆ° brightnessï¼š1 Â± 0.35*EVï¼ˆä½ å¯è°ƒæ›´åƒ iOSï¼‰
        const b = 1 + State.expEV * 0.35;
        cameraAreaEl && cameraAreaEl.style.setProperty('--exp', b.toFixed(2));
        expRange && (expRange.value = String(State.expEV));
      }

      expRange && expRange.addEventListener('input', () => setExposureEV(parseFloat(expRange.value)));

      let expTimer = null;
      let expActive = false;
      let expPointerId = null;

      cameraAreaEl && cameraAreaEl.addEventListener('pointerdown', (e) => {
        if (isOnUI(e.target)) return;
        // åŒæŒ‡æ—¶ä¸è§¦å‘æ›å…‰
        if (pointers.size >= 1) return;

        expPointerId = e.pointerId;
        clearTimeout(expTimer);
        expTimer = setTimeout(() => {
          expActive = true;

          // æ˜¾ç¤ºå¯¹ç„¦æ¡†ï¼ˆiOSæ„Ÿè§‰ï¼‰
          if (focusBox) {
            focusBox.style.left = (e.clientX - 37) + 'px';
            focusBox.style.top = (e.clientY - 37) + 'px';
            focusBox.style.display = 'block';
          }
          // æ˜¾ç¤ºæ›å…‰æ¡ï¼ˆæ”¾åœ¨æ¡†å³ä¾§ï¼Œé¿å…æŒ¡ä½ï¼‰
          if (expHud) {
            expHud.style.left = (e.clientX + 52) + 'px';
            expHud.style.top = (e.clientY - 40) + 'px';
            expHud.style.display = 'block';
          }
        }, 330); // é•¿æŒ‰è§¦å‘ï¼ˆæ¥è¿‘ iOSï¼‰
      });

      cameraAreaEl && cameraAreaEl.addEventListener('pointerup', () => {
        clearTimeout(expTimer);
        if (expActive) {
          expActive = false;
          // 1.2s åè‡ªåŠ¨æ”¶èµ·ï¼ˆåƒ iOSï¼‰
          setTimeout(() => {
            if (focusBox) focusBox.style.display = 'none';
            if (expHud) expHud.style.display = 'none';
          }, 1200);
        }
      });
      cameraAreaEl && cameraAreaEl.addEventListener('pointercancel', () => {
        clearTimeout(expTimer);
        expActive = false;
        if (focusBox) focusBox.style.display = 'none';
        if (expHud) expHud.style.display = 'none';
      });
      const resetSessionHard = () => {
        // æ¸…ç©ºä¼šè¯æ•°æ®
        State.session.photos = [];
        State.session.location = "";
        // å¦‚ä½ æƒ³è¿â€œæœ¬æ¬¡ä¸é‡å¤â€ä¹Ÿæ¸…æ‰ï¼Œå°±ä¿ç•™ä¸‹é¢ä¸¤è¡Œï¼›ä¸æƒ³æ¸…å°±åˆ æ‰
        State.session.usedKeywords = { cafe: [], outdoor: [] };
        State.session.usedPrompts = { cafe: [], outdoor: [] };
        State.session.usedPraise = { cafe: [], outdoor: [] };

        // å…³é—­æ”¶å·¥é¡µ/å¼¹å±‚
        const wrapPage = document.getElementById('wrapPage');
        wrapPage && wrapPage.classList.remove('show');

        // é‡ç½®å˜ç„¦/æ›å…‰ï¼ˆä¸‹é¢ç¬¬4/5æ¡ä¼šç”¨åˆ°ï¼‰
        setZoom(1);
        setExposureEV(0);

        // å›åˆ° S0ï¼Œå¹¶åˆ·æ–° UI
        setState('S0');
        renderFilmstrip && renderFilmstrip();
        updateWrapAvailability && updateWrapAvailability();

        // é‡æ–°ç»™ä¸€æ¡å°è¯/å¤¸å¤¸
        setNewPrompt && setNewPrompt("reset");
        setNewPraise && setNewPraise("reset");

        toast("å·²é‡ç½®ï¼Œæœ¬è½®é‡æ–°å¼€å§‹");
      };

      btnReset && (btnReset.onclick = () => {
        if (!State.session.photos.length) {
          toast("å½“å‰æ²¡æœ‰å¯é‡ç½®å†…å®¹");
          return;
        }
        resetModal.classList.add('show');
      });

      resetCancel && (resetCancel.onclick = () => resetModal.classList.remove('show'));

      resetConfirm && (resetConfirm.onclick = () => {
        resetModal.classList.remove('show');
        resetSessionHard();
      });

      // ---------- Script card drag ----------
      let scDrag = { on: false, startY: 0, startTop: 0 };
      scriptCard.addEventListener('pointerdown', (e) => {
        scDrag.on = true;
        scriptCard.setPointerCapture(e.pointerId);
        scDrag.startY = e.clientY;
        const rect = scriptCard.getBoundingClientRect();
        const parent = $('#phone').getBoundingClientRect();
        scDrag.startTop = rect.top - parent.top;
        scriptCard.style.cursor = 'grabbing';
      });
      scriptCard.addEventListener('pointermove', (e) => {
        if (!scDrag.on) return;
        const parent = $('#phone').getBoundingClientRect();
        const newTop = scDrag.startTop + (e.clientY - scDrag.startY);
        const maxTop = parent.height - 160;
        const clamped = clamp(newTop, 70, maxTop);
        scriptCard.style.top = clamped + "px";
        scriptCard.style.transform = "translateY(0)";
      });
      scriptCard.addEventListener('pointerup', () => {
        scDrag.on = false;
        scriptCard.style.cursor = 'grab';
      });

      // ---------- Reference overlay ----------
      const refOverlay = $('#refOverlay');
      const refImg = $('#refImg');
      const refHide = $('#refHide');
      const refSize = $('#refSize');

      // ç¦æ­¢æµè§ˆå™¨é»˜è®¤å›¾ç‰‡æ‹–æ‹½ï¼ˆå¦åˆ™ä¼šè®©å¯æ‹–åŠ¨çƒ­åŒºâ€œå˜å°â€ï¼‰
      try { refImg.draggable = false; } catch (_) {}

      let ref = { size: 'small', dragging: false, longPressTimer: null, startX: 0, startY: 0, startLeft: 0, startTop: 0, pointerId: null };

      function applyRefSize() {
        if (ref.size === 'small') {
          refOverlay.style.width = "132px";
          refOverlay.style.height = "176px";
          refSize.textContent = "å¤§";
        } else {
          refOverlay.style.width = "180px";
          refOverlay.style.height = "240px";
          refSize.textContent = "å°";
        }
        snapRefToBounds();
      }
      function snapRefToBounds() {
        const phone = $('#phone').getBoundingClientRect();
        const r = refOverlay.getBoundingClientRect();
        const safe = 14;
        const topMin = 70;
        const bottomMax = phone.height - 120;
        const leftMin = safe;
        const rightMax = phone.width - safe;

        const curLeft = r.left - phone.left;
        const curTop = r.top - phone.top;
        let newLeft = clamp(curLeft, leftMin, rightMax - r.width);
        let newTop = clamp(curTop, topMin, bottomMax - r.height);

        const snap = 10;
        if (Math.abs(newLeft - leftMin) < snap) newLeft = leftMin;
        if (Math.abs((newLeft + r.width) - (rightMax)) < snap) newLeft = rightMax - r.width;
        if (Math.abs(newTop - topMin) < snap) newTop = topMin;

        refOverlay.style.left = newLeft + "px";
        refOverlay.style.top = newTop + "px";
        refOverlay.style.right = "auto";
        refOverlay.style.bottom = "auto";
      }
      function resetRef() {
        ref.size = 'small';
        applyRefSize();
        const phone = $('#phone').getBoundingClientRect();
        const r = refOverlay.getBoundingClientRect();
        const safe = 14;
        const bottomSafe = 210;
        const topMin = 70;

        const left = safe;
        const top = clamp(phone.height - bottomSafe - r.height, topMin, phone.height - 120 - r.height);

        refOverlay.style.left = left + "px";
        refOverlay.style.top = top + "px";
        refOverlay.style.right = "auto";
        refOverlay.style.bottom = "auto";
        toast("å‚è€ƒå›¾ï¼šå·²å¤ä½");
      }
      refOverlay.addEventListener('dblclick', () => resetRef());

      refOverlay.addEventListener('pointerdown', (e) => {
        // ç›®æ ‡ï¼šæ‹–åŠ¨çƒ­åŒº=æ•´å¼ å‚è€ƒå›¾ï¼ˆé™¤äº†ä¸¤ä¸ªæŒ‰é’®ï¼‰
        if (e.target === refHide || e.target === refSize) return;

        // é˜²æ­¢æµè§ˆå™¨æŠŠå›¾ç‰‡å½“ä½œâ€œå¯æ‹–æ‹½å…ƒç´ â€å¯¼è‡´åªèƒ½åœ¨åº•éƒ¨å°åŒºåŸŸæ‹–åŠ¨
        e.preventDefault();

        const phone = $('#phone').getBoundingClientRect();
        const r = refOverlay.getBoundingClientRect();
        ref.startX = e.clientX;
        ref.startY = e.clientY;
        ref.startLeft = r.left - phone.left;
        ref.startTop = r.top - phone.top;

        ref.dragging = false;
        ref.pointerId = e.pointerId;

        // ç«‹å³æ•è·æŒ‡é’ˆï¼Œä¿è¯æ‹–åŠ¨ä¸­é€”ç§»å‡ºä¹Ÿä¸æ–­
        try { refOverlay.setPointerCapture(e.pointerId); } catch (_) {}

        // å…¼å®¹ï¼šè½»å¾®ç§»åŠ¨å³å¯æ‹–ï¼›ä¸åŠ¨æ—¶ä¹Ÿæ”¯æŒâ€œçŸ­é•¿æŒ‰â€å†æ‹–
        clearTimeout(ref.longPressTimer);
        ref.longPressTimer = setTimeout(() => { ref.dragging = true; }, 160);
      });

      refOverlay.addEventListener('pointermove', (e) => {
        if (ref.pointerId != null && e.pointerId !== ref.pointerId) return;

        const dx = e.clientX - ref.startX;
        const dy = e.clientY - ref.startY;
        const dist = Math.hypot(dx, dy);

        // æ²¡æœ‰è¾¾åˆ°æ‹–åŠ¨æ¡ä»¶ï¼šç¨å¾®åŠ¨ä¸€ç‚¹å°±å¼€å§‹ï¼ˆæ›´ç¬¦åˆç›´è§‰ï¼‰
        if (!ref.dragging) {
          if (dist <= 6) return;
          ref.dragging = true;
          clearTimeout(ref.longPressTimer);
        }

        refOverlay.style.left = (ref.startLeft + dx) + "px";
        refOverlay.style.top = (ref.startTop + dy) + "px";
        refOverlay.style.right = "auto";
        refOverlay.style.bottom = "auto";
      });

      function endRefDrag(e) {
        clearTimeout(ref.longPressTimer);
        if (ref.dragging) {
          ref.dragging = false;
          snapRefToBounds();
        }
        if (ref.pointerId != null) {
          try { refOverlay.releasePointerCapture(ref.pointerId); } catch (_) {}
        }
        ref.pointerId = null;
      }
      refOverlay.addEventListener('pointerup', endRefDrag);
      refOverlay.addEventListener('pointercancel', endRefDrag);

      refHide.onclick = () => { refOverlay.classList.remove('show'); toast("å‚è€ƒå›¾ï¼šå·²éšè—"); };
      refSize.onclick = () => { ref.size = (ref.size === 'small') ? 'large' : 'small'; applyRefSize(); toast("å‚è€ƒå›¾ï¼š" + (ref.size === 'small' ? "å°" : "å¤§")); };

      // ---------- Settings / add reference / import ----------
      const sheetSettings = $('#sheetSettings');
      $('#btnSettings').onclick = () => sheetSettings.classList.add('show');
      $('#closeSettings').onclick = () => sheetSettings.classList.remove('show');

      const fileRef = $('#fileRef');
      const fileImport = $('#fileImport');

      // å‚è€ƒå›¾æŒ‰é’®ï¼ˆå·²ç§»åŠ¨åˆ°åº•éƒ¨å·¦ä¸‹ç¬¬ä¸€ä¸ªï¼‰
      btnAddRef.onclick = () => fileRef.click();

      fileRef.addEventListener('change', () => {
        const f = fileRef.files && fileRef.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        refImg.src = url;
        refOverlay.classList.add('show');
        resetRef();
        toast("å‚è€ƒå›¾ï¼šå·²æ·»åŠ ï¼ˆæ•´å¼ å¯æ‹–åŠ¨ï¼ŒåŒå‡»å¤ä½ï¼‰");
        fileRef.value = "";
      });

      $('#toggleGrid').onclick = () => { State.grid = !State.grid; grid.classList.toggle('on', State.grid); toast("æ„å›¾ç½‘æ ¼ï¼š" + (State.grid ? "å¼€" : "å…³")); };

      function setScope(scope) {
        State.perm.scope = scope;
        $('#scopeJP').classList.toggle('active', scope === 'jp');
        $('#scopeFull').classList.toggle('active', scope === 'full');
        toast("è¯»å–èŒƒå›´ï¼š" + (scope === 'jp' ? "ä»… Just Photo" : "å…¨éƒ¨ç…§ç‰‡"));
      }
      $('#scopeJP').onclick = () => setScope('jp');
      $('#scopeFull').onclick = () => setScope('full');

      $('#btnGoSettings').onclick = () => toast("ï¼ˆæ¨¡æ‹Ÿï¼‰è·³è½¬ç³»ç»Ÿè®¾ç½®ï¼šç®¡ç†ç…§ç‰‡æƒé™");
      $('#btnImport').onclick = () => fileImport.click();

      fileImport.addEventListener('change', async () => {
        const files = [...(fileImport.files || [])];
        if (!files.length) return;
        for (const f of files.slice(0, 12)) {
          const url = URL.createObjectURL(f);
          await addPhotoFromUrl(url, { imported: true });
        }
        toast(`å·²å½’æ¡£ ${Math.min(files.length, 12)} å¼ åˆ° Just Photoï¼ˆæ¨¡æ‹Ÿï¼‰`);
        fileImport.value = "";
      });

      // ---------- Inspiration ----------
      const sheetInspo = $('#sheetInspo');
      $('#closeInspo').onclick = () => sheetInspo.classList.remove('show');

      function pickKeywords(scene, count) {
        const used = State.session.usedKeywords[scene];
        const pool = INSPO[scene];
        const usedSet = new Set(used);

        let candidates = pool.filter(x => !usedSet.has(x));
        if (candidates.length < count) {
          const recent = new Set(used.slice(-5));
          candidates = pool.filter(x => !recent.has(x));
          if (candidates.length < count) candidates = pool.slice();
        }

        const out = [];
        while (out.length < count) {
          const k = candidates[Math.floor(Math.random() * candidates.length)];
          if (!out.includes(k)) out.push(k);
          if (out.length >= candidates.length) break;
        }
        out.forEach(k => used.push(k));
        if (used.length > 80) used.splice(0, used.length - 80);
        return out;
      }

      async function copyText(txt) {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(txt);
            return true;
          }
        } catch (e) { }
        const ta = document.createElement('textarea');
        ta.value = txt;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); ta.remove(); return true; }
        catch (e) { ta.remove(); return false; }
      }

      function openInspo() {
        const list = $('#inspoList');
        list.innerHTML = '';
        const keys = pickKeywords(State.scene, 4);
        keys.forEach(k => {
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `<div class="txt">${k}</div><button class="copyBtn">å¤åˆ¶</button>`;
          row.querySelector('button').onclick = async () => {
            const ok = await copyText(k);
            toast(ok ? "å·²å¤åˆ¶" : "å¤åˆ¶å¤±è´¥ï¼ˆè¯·ç”¨ localhost/httpsï¼‰");
          };
          list.appendChild(row);
        });
        sheetInspo.classList.add('show');
      }
      btnInspo.onclick = openInspo;

      // ---------- Permission Flow ----------
      const permModal = $('#permModal');
      const permTitle = $('#permTitle');
      const permDesc = $('#permDesc');
      const permButtons = $('#permButtons');

      function showPerm(step) {
        permModal.classList.add('show');

        if (step === 0) {
          permTitle.textContent = "éœ€è¦ç›¸å†Œæƒé™æ‰èƒ½ä½¿ç”¨";
          permDesc.textContent = "Just Photo ä¼šæŠŠä½ æ‹çš„ç…§ç‰‡ä¿å­˜åˆ°ç³»ç»Ÿç›¸å†Œï¼Œå¹¶å†™å…¥ã€ŒJust Photoã€ä¸“å±ç›¸å†Œï¼ˆä¸ä¼šä¸Šä¼ ï¼‰ã€‚";
          permButtons.innerHTML = `
        <button class="cta secondary" id="permExit">é€€å‡º</button>
        <button class="cta" id="permContinue">ç»§ç»­</button>
      `;
          $('#permExit').onclick = () => toast("å·²é€€å‡ºï¼ˆåŸå‹ä¸­ç”¨é®ç½©æ¨¡æ‹Ÿï¼šæ— æ³•è¿›å…¥æ‹æ‘„é¡µï¼‰");
          $('#permContinue').onclick = () => showPerm(1);
        }

        if (step === 1) {
          permTitle.textContent = "ç³»ç»Ÿç›¸å†Œæƒé™ï¼ˆæ¨¡æ‹Ÿï¼‰";
          permDesc.textContent = "Just Photo éœ€è¦ Photos è¯»å†™æƒé™ã€‚è¯·é€‰æ‹©ï¼šå…è®¸ / ä¸å…è®¸ã€‚";
          permButtons.innerHTML = `
        <button class="cta danger" id="permDeny">ä¸å…è®¸</button>
        <button class="cta" id="permAllow">å…è®¸</button>
      `;
          $('#permDeny').onclick = () => { State.perm.denied = true; State.perm.granted = false; showPerm(11); };
          $('#permAllow').onclick = () => { State.perm.granted = true; State.perm.denied = false; showPerm(2); };
        }

        if (step === 11) {
          permTitle.textContent = "æœªå¼€å¯ç›¸å†Œæƒé™ï¼Œæ— æ³•ä½¿ç”¨";
          permDesc.textContent = "Just Photo æ— æ³•ä¿å­˜ç…§ç‰‡ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ã€‚";
          permButtons.innerHTML = `
        <button class="cta secondary" id="permExit2">é€€å‡º</button>
        <button class="cta" id="permGoSettings">å»è®¾ç½®å¼€å¯</button>
      `;
          $('#permExit2').onclick = () => toast("å·²é€€å‡ºï¼ˆä»åœç•™åœ¨é˜»æ–­é¡µï¼‰");
          $('#permGoSettings').onclick = () => toast("ï¼ˆæ¨¡æ‹Ÿï¼‰è·³è½¬ç³»ç»Ÿè®¾ç½®ï¼šè¯·åœ¨ç³»ç»Ÿä¸­å¼€å¯ç…§ç‰‡æƒé™");
        }

        if (step === 2) {
          permTitle.textContent = "å…è®¸è¯»å–å…¨éƒ¨ç…§ç‰‡å—ï¼Ÿ";
          permDesc.textContent = "ä½ åªéœ€è¦åšè¿™ä¸ªé€‰æ‹©ï¼šä¸å…è®¸åˆ™ä»…æ˜¾ç¤ºã€ŒJust Photoã€ç›¸å†Œï¼›å…è®¸åˆ™å¯è¯»å–å…¨éƒ¨ç…§ç‰‡å¹¶åŒæ­¥ç³»ç»Ÿ Favoriteã€‚";
          permButtons.innerHTML = `
        <button class="cta secondary" id="scopeA">ä¸å…è®¸ï¼ˆæ¨èï¼Œæ›´éšç§ï¼‰</button>
        <button class="cta" id="scopeB">å…è®¸ï¼ˆæ›´å¥½ç®¡ç†ï¼‰</button>
      `;
          $('#scopeA').onclick = async () => { State.perm.scope = 'jp'; setScope('jp'); permModal.classList.remove('show'); await enterCamera(); };
          $('#scopeB').onclick = async () => { State.perm.scope = 'full'; setScope('full'); permModal.classList.remove('show'); await enterCamera(); };
        }
      }

      async function checkLowStorage() {
        try {
          if (navigator.storage && navigator.storage.estimate) {
            const est = await navigator.storage.estimate();
            const free = est.quota - est.usage;
            if (free < 200 * 1024 * 1024) {
              showCenterWarn("ç©ºé—´ä¸è¶³", "ç©ºé—´ä¸è¶³ï¼Œç…§ç‰‡å¯èƒ½æ— æ³•ä¿å­˜ã€‚å»ºè®®å…ˆæ¸…ç†å†æ‹ï¼Œé¿å…æ‹äº†åŠå¤©æ²¡ä¿å­˜æˆåŠŸã€‚");
            }
          } else {
            if (Math.random() < 0.15) {
              showCenterWarn("ç©ºé—´ä¸è¶³", "ç©ºé—´ä¸è¶³ï¼Œç…§ç‰‡å¯èƒ½æ— æ³•ä¿å­˜ã€‚å»ºè®®å…ˆæ¸…ç†å†æ‹ï¼Œé¿å…æ‹äº†åŠå¤©æ²¡ä¿å­˜æˆåŠŸã€‚");
            }
          }
        } catch (e) { }
      }

      function showCenterWarn(title, desc) {
        const cm = $('#permModal');
        const t = $('#permTitle');
        const d = $('#permDesc');
        const b = $('#permButtons');
        cm.classList.add('show');
        t.textContent = title;
        d.textContent = desc;
        b.innerHTML = `
      <button class="cta secondary" id="warnOk">æˆ‘çŸ¥é“äº†</button>
      <button class="cta" id="warnClean">å»æ¸…ç†ç©ºé—´</button>
    `;
        $('#warnOk').onclick = () => cm.classList.remove('show');
        $('#warnClean').onclick = () => { toast("ï¼ˆæ¨¡æ‹Ÿï¼‰æ‰“å¼€ç³»ç»Ÿå­˜å‚¨ç®¡ç†"); cm.classList.remove('show'); };
      }

      async function createAlbum() {
        State.albumOk = Math.random() >= 0.10;
        if (State.albumOk) {
          toast("å·²å°±ç»ªï¼šJust Photo ç›¸å†Œ");
        } else {
          showCenterWarn("æœªèƒ½å½’æ¡£åˆ° Just Photo ç›¸å†Œ", "ä»ä¼šå†™å…¥ç³»ç»Ÿç›¸å†Œæ€»åº“ã€‚ä½ å¯ä»¥ç¨åé‡è¯•æˆ–å»è®¾ç½®æ£€æŸ¥æƒé™ã€‚");
        }
      }

      async function warmupCamera() {
        warmup.classList.add('show');
        shutter.disabled = true;

        let streamOk = false;
        try {
          if (location.protocol === 'https:' || location.hostname === 'localhost') {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: State.cameraFacing },
              audio: false
            });
            video.srcObject = stream;
            video.style.display = '';
            fallbackPreview.style.display = 'none';
            streamOk = true;
          } else {
            throw new Error("file:// not allowed");
          }
        } catch (e) {
          video.style.display = 'none';
          fallbackPreview.style.display = '';
          streamOk = false;
        }

        const warmMs = clamp(1200 + Math.random() * 1100, 900, 2800);
        await sleep(warmMs);

        warmup.classList.remove('show');
        State.warm = true;
        shutter.disabled = false;

        toast(streamOk ? "ç›¸æœºå·²å°±ç»ªï¼ˆå¯æ‹ï¼‰" : "é¢„è§ˆä¸ºå ä½ï¼ˆå»ºè®®ç”¨ localhost æ‰“å¼€è·å–ç›¸æœºï¼‰");
      }

      async function enterCamera() {
        await checkLowStorage();
        await createAlbum();
        await warmupCamera();

        setScene(State.scene);
        setNewPrompt();
        setNewPraise();
        renderPraiseBody();

        praiseOpen = false;
        updatePromptVisibilityForFacing();

        setState('S0');
      }

      // ---------- State machine ----------
      function setState(s) {
        State.s = s;
        if (s === 'S0') {
          filmstripWrap.classList.remove('show');
          btnWrap.classList.add('hidden');
          btnNoGood.classList.add('hidden');
        } else if (s === 'S1') {
          filmstripWrap.classList.add('show');
          updateWrapAvailability();
        }
      }
      function updateWrapAvailability() {
        const shots = State.session.photos.length;
        const liked = State.session.photos.filter(p => p.liked).length;

        if (shots >= 3 || liked >= 1) btnWrap.classList.remove('hidden');
        else btnWrap.classList.add('hidden');

        if (shots >= 10) btnNoGood.classList.remove('hidden');
        else btnNoGood.classList.add('hidden');
      }

      // ---------- Capture / photos ----------
      let photoId = 0;
      function getFrameDataURL(w = 240, h = 320) {
        cap.width = w; cap.height = h;
        if (video.style.display !== 'none' && video.videoWidth) {
          const z = State.zoom || 1;
          const vw = video.videoWidth, vh = video.videoHeight;
          if (vw && vh) {
            const sw = vw / z;
            const sh = vh / z;
            const sx = (vw - sw) / 2;
            const sy = (vh - sh) / 2;
            capCtx.drawImage(video, sx, sy, sw, sh, 0, 0, w, h);
          } else {
            capCtx.drawImage(video, 0, 0, w, h);
          }
        } else {
          const g = capCtx.createLinearGradient(0, 0, w, h);
          g.addColorStop(0, "rgba(255,255,255,.10)");
          g.addColorStop(1, "rgba(255,255,255,.03)");
          capCtx.fillStyle = g;
          capCtx.fillRect(0, 0, w, h);

          capCtx.fillStyle = "rgba(255,255,255,.65)";
          capCtx.font = "14px system-ui";
          capCtx.fillText(State.scene === 'cafe' ? "Cafe Preview" : "Outdoor Preview", 14, 26);

          capCtx.strokeStyle = "rgba(255,255,255,.25)";
          capCtx.strokeRect(12, 40, w - 24, h - 52);
        }
        return cap.toDataURL('image/jpeg', 0.72);
      }

      async function addPhotoFromUrl(url, { imported = false } = {}) {
        const id = ++photoId;
        const p = { id, thumb: url, real: url, saved: true, failed: false, liked: false, ts: Date.now(), imported };
        State.session.photos.push(p);
        if (State.session.photos.length >= 1) setState('S1');
        renderFilmstrip();
        updateWrapAvailability();
      }

      shutter.onclick = async () => {
        if (!State.warm) { toast("ç›¸æœºæœªå°±ç»ª"); return; }

        const id = ++photoId;

        const optimistic = getFrameDataURL(240, 320);
        const p = { id, thumb: optimistic, real: null, saved: false, failed: false, liked: false, ts: Date.now(), imported: false };
        State.session.photos.push(p);

        if (State.session.photos.length === 1) setState('S1');

        // after shot
        setNewPrompt();
        setNewPraise();
        if (praiseCard.classList.contains('expanded')) renderPraiseBody();
        updatePromptVisibilityForFacing();

        renderFilmstrip(true);
        updateWrapAvailability();
        microRemind();

        const writeDelay = clamp(250 + Math.random() * 1100, 220, 1400);
        setTimeout(() => {
          const ok = Math.random() > 0.08;
          if (ok) {
            p.saved = true;
            p.real = getFrameDataURL(360, 480);
            p.thumb = p.real;
            renderFilmstrip();
          } else {
            p.failed = true;
            p.saved = false;
            renderFilmstrip();
            toast("ä¿å­˜å¤±è´¥ï¼šè¯·æ£€æŸ¥æƒé™/ç©ºé—´");
          }
        }, writeDelay);
      };

      function renderFilmstrip(animate = false) {
        filmstrip.innerHTML = '';
        const photos = State.session.photos.slice().reverse();
        photos.forEach(p => {
          const t = document.createElement('div');
          t.className = 'thumb' + (p.liked ? ' liked' : '') + (p.failed ? ' failed' : '');
          t.innerHTML = `<img src="${p.thumb}" alt="thumb"/><div class="badge">âœ…</div>`;
          t.onclick = () => openThumbViewer(p.id);
          filmstrip.appendChild(t);
        });
        if (animate) filmstripWrap.classList.add('flash');
      }
      function findPhoto(id) { return State.session.photos.find(x => x.id === id); }

      // ---------- Filmstrip thumbnail preview (å¢å¼ºï¼šiOS ç›¸å†Œçº§æ‰‹åŠ¿) ----------
      const viewerState = {
        ids: [],
        index: 0,
        scale: 1,
        tx: 0,
        ty: 0,
        pointers: new Map(),
        gesture: null, // 'swipe' | 'pan' | 'pinch'
        startX: 0, startY: 0, startTx: 0, startTy: 0,
        startScale: 1, startDist: 0, startMidX: 0, startMidY: 0,
        swipeDx: 0, swipeDy: 0,
        lastTapAt: 0, lastTapX: 0, lastTapY: 0
      };

      function buildViewerIds() {
        return State.session.photos.filter(p => !p.failed).map(p => p.id);
      }

      function getViewerRect() {
        return (viewerStage || viewerImgWrap).getBoundingClientRect();
      }

      function applyViewerTransform(extraX = 0, extraY = 0) {
        const s = viewerState.scale;
        const x = viewerState.tx + extraX;
        const y = viewerState.ty + extraY;
        viewerImg.style.transform = `translate3d(${x}px, ${y}px, 0) scale(${s})`;
      }

      function clampViewerPan() {
        const rect = getViewerRect();
        const maxX = (rect.width * (viewerState.scale - 1)) / 2;
        const maxY = (rect.height * (viewerState.scale - 1)) / 2;
        viewerState.tx = clamp(viewerState.tx, -maxX, maxX);
        viewerState.ty = clamp(viewerState.ty, -maxY, maxY);
      }

      function resetViewerZoom() {
        viewerState.scale = 1;
        viewerState.tx = 0;
        viewerState.ty = 0;
        viewerImgWrap && viewerImgWrap.classList.remove('grabbing');
        applyViewerTransform();
      }

      function updateViewerUI() {
        const total = viewerState.ids.length || 1;
        const cur = Math.min(viewerState.index + 1, total);
        viewerTitle.textContent = `é¢„è§ˆ ${cur}/${total}`;
        viewerCounter && (viewerCounter.textContent = `${cur} / ${total}`);
        const p = findPhoto(viewerState.ids[viewerState.index]);
        if (p) viewerToggle.textContent = p.liked ? "å–æ¶ˆâœ…" : "âœ… é€‰ä¸­";
      }

      function setViewerIndex(i) {
        if (!viewerState.ids.length) return;
        viewerState.index = clamp(i, 0, viewerState.ids.length - 1);
        const id = viewerState.ids[viewerState.index];
        const p = findPhoto(id);
        if (!p) return;

        viewerImg.style.transition = "";
        viewerImg.src = (p.real || p.thumb);

        resetViewerZoom();
        updateViewerUI();
      }

      function openThumbViewer(id) {
        const p = findPhoto(id);
        if (!p) return;
        if (p.failed) { toast("è¯¥å¼ ä¿å­˜å¤±è´¥ï¼ˆæ¨¡æ‹Ÿï¼‰ï¼Œæ— æ³•é¢„è§ˆ/é€‰ä¸­"); return; }

        viewerState.ids = buildViewerIds();
        viewerState.index = Math.max(0, viewerState.ids.indexOf(id));
        viewerState.pointers.clear();
        viewerState.gesture = null;
        viewerState.startDist = 0;

        thumbViewer.classList.add('show');
        setViewerIndex(viewerState.index);
      }

      function closeThumbViewer() {
        thumbViewer.classList.remove('show');
        viewerState.pointers.clear();
        viewerState.ids = [];
        viewerState.index = 0;
        viewerState.gesture = null;
        viewerState.startDist = 0;
        resetViewerZoom();
      }

      viewerClose && (viewerClose.onclick = () => closeThumbViewer());
      thumbViewer && thumbViewer.addEventListener('click', (e) => {
        if (e.target === thumbViewer) closeThumbViewer();
      });

      // å³ä¸ŠæŒ‰é’®ï¼šåœ¨å¤§å›¾é‡Œå†â€œé€‰ä¸­/å–æ¶ˆâ€
      viewerToggle && (viewerToggle.onclick = () => {
        const id = viewerState.ids[viewerState.index];
        if (!id) return;
        onThumbTap(id);
        const p = findPhoto(id);
        if (p) viewerToggle.textContent = p.liked ? "å–æ¶ˆâœ…" : "âœ… é€‰ä¸­";
      });

      function navViewer(delta) {
        if (!viewerState.ids.length) return;

        // ç¼©æ”¾æ—¶é”å®šç¿»é¡µï¼ˆè´´è¿‘ iOS ç›¸å†Œï¼‰
        if (viewerState.scale > 1.01) return;

        const next = viewerState.index + delta;
        const rect = getViewerRect();

        if (next < 0 || next >= viewerState.ids.length) {
          // edge bounce
          viewerImg.style.transition = "transform 120ms ease";
          applyViewerTransform(delta > 0 ? -24 : 24, 0);
          setTimeout(() => {
            applyViewerTransform(0, 0);
            setTimeout(() => { viewerImg.style.transition = ""; }, 130);
          }, 10);
          return;
        }

        viewerImg.style.transition = "transform 160ms ease";
        applyViewerTransform(delta > 0 ? -rect.width * 0.22 : rect.width * 0.22, 0);
        setTimeout(() => {
          viewerImg.style.transition = "";
          setViewerIndex(next);
        }, 140);
      }

      function toggleZoomAt(clientX, clientY) {
        const rect = getViewerRect();
        if (viewerState.scale <= 1.01) {
          viewerState.scale = 2.5;
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          viewerState.tx = (cx - clientX) * (viewerState.scale - 1);
          viewerState.ty = (cy - clientY) * (viewerState.scale - 1);
          clampViewerPan();
          applyViewerTransform();
        } else {
          resetViewerZoom();
        }
      }

      function dist2(a, b) {
        const dx = a.x - b.x, dy = a.y - b.y;
        return Math.sqrt(dx * dx + dy * dy);
      }

      function mid2(a, b) {
        return { x: (a.x + b.x) / 2, y: (a.y + b.y) / 2 };
      }

      function onViewerPointerDown(e) {
        if (!thumbViewer.classList.contains('show')) return;
        e.preventDefault();
        viewerImgWrap && viewerImgWrap.setPointerCapture && viewerImgWrap.setPointerCapture(e.pointerId);
        viewerState.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

        // touch double tapï¼ˆæ›´åƒ iOSï¼‰
        const t = Date.now();
        const dt = t - viewerState.lastTapAt;
        const dTap = Math.hypot(e.clientX - viewerState.lastTapX, e.clientY - viewerState.lastTapY);
        if (dt < 280 && dTap < 26 && viewerState.pointers.size === 1) {
          viewerState.lastTapAt = 0;
          toggleZoomAt(e.clientX, e.clientY);
          return;
        }
        viewerState.lastTapAt = t;
        viewerState.lastTapX = e.clientX;
        viewerState.lastTapY = e.clientY;

        viewerState.startX = e.clientX;
        viewerState.startY = e.clientY;
        viewerState.startTx = viewerState.tx;
        viewerState.startTy = viewerState.ty;
        viewerState.startScale = viewerState.scale;
        viewerState.swipeDx = 0;
        viewerState.swipeDy = 0;

        if (viewerState.pointers.size === 2) {
          const pts = [...viewerState.pointers.values()];
          viewerState.gesture = 'pinch';
          viewerState.startDist = dist2(pts[0], pts[1]);
          const mid = mid2(pts[0], pts[1]);
          viewerState.startMidX = mid.x;
          viewerState.startMidY = mid.y;
        } else {
          viewerState.gesture = (viewerState.scale > 1.01) ? 'pan' : 'swipe';
          if (viewerState.gesture === 'pan') viewerImgWrap && viewerImgWrap.classList.add('grabbing');
        }
      }

      function onViewerPointerMove(e) {
        if (!thumbViewer.classList.contains('show')) return;
        if (!viewerState.pointers.has(e.pointerId)) return;

        viewerState.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

        if (viewerState.pointers.size === 2) {
          // pinch zoom
          const pts = [...viewerState.pointers.values()];
          const d = dist2(pts[0], pts[1]);
          const mid = mid2(pts[0], pts[1]);

          if (!viewerState.startDist) viewerState.startDist = d;
          const rect = getViewerRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;

          let nextScale = viewerState.startScale * (d / viewerState.startDist);
          nextScale = clamp(nextScale, 1, 4);

          const scaleDelta = nextScale / viewerState.startScale;
          const midDx = mid.x - viewerState.startMidX;
          const midDy = mid.y - viewerState.startMidY;

          viewerState.scale = nextScale;
          viewerState.tx = viewerState.startTx + midDx + (1 - scaleDelta) * (viewerState.startMidX - cx);
          viewerState.ty = viewerState.startTy + midDy + (1 - scaleDelta) * (viewerState.startMidY - cy);

          clampViewerPan();
          applyViewerTransform();
          return;
        }

        // single pointer
        const dx = e.clientX - viewerState.startX;
        const dy = e.clientY - viewerState.startY;

        if (viewerState.scale > 1.01) {
          viewerState.gesture = 'pan';
          viewerState.tx = viewerState.startTx + dx;
          viewerState.ty = viewerState.startTy + dy;
          clampViewerPan();
          applyViewerTransform();
        } else {
          viewerState.gesture = 'swipe';
          viewerState.swipeDx = dx;
          viewerState.swipeDy = dy;

          // feedback: move image slightly with finger
          viewerImg.style.transition = "";
          const limited = clamp(dx, -140, 140);
          applyViewerTransform(limited, 0);
        }
      }

      function onViewerPointerUp(e) {
        if (!viewerState.pointers.has(e.pointerId)) return;
        viewerState.pointers.delete(e.pointerId);

        if (viewerState.pointers.size >= 2) return;

        // pinch -> end
        if (viewerState.gesture === 'pinch') {
          viewerState.startDist = 0;
          viewerState.startScale = viewerState.scale;
          viewerState.startTx = viewerState.tx;
          viewerState.startTy = viewerState.ty;
          viewerState.gesture = (viewerState.scale > 1.01) ? 'pan' : null;
          applyViewerTransform();
          return;
        }

        if (viewerState.scale > 1.01) {
          viewerImgWrap && viewerImgWrap.classList.remove('grabbing');
          clampViewerPan();
          applyViewerTransform();
          viewerState.gesture = null;
          return;
        }

        // swipe end
        const dx = viewerState.swipeDx || 0;
        const dy = viewerState.swipeDy || 0;
        const absX = Math.abs(dx), absY = Math.abs(dy);

        if (absX > 70 && absX > absY * 1.2) {
          navViewer(dx < 0 ? +1 : -1);
        } else {
          viewerImg.style.transition = "transform 140ms ease";
          applyViewerTransform(0, 0);
          setTimeout(() => { viewerImg.style.transition = ""; }, 160);
        }
        viewerState.gesture = null;
      }

      if (viewerImgWrap) {
        viewerImgWrap.addEventListener('pointerdown', onViewerPointerDown);
        viewerImgWrap.addEventListener('pointermove', onViewerPointerMove);
        viewerImgWrap.addEventListener('pointerup', onViewerPointerUp);
        viewerImgWrap.addEventListener('pointercancel', onViewerPointerUp);
      }

      // é”®ç›˜å·¦å³é”®ï¼ˆæ¡Œé¢éªŒè¯æ›´æ–¹ä¾¿ï¼‰
      document.addEventListener('keydown', (e) => {
        if (!thumbViewer.classList.contains('show')) return;
        if (e.key === 'ArrowLeft') navViewer(-1);
        if (e.key === 'ArrowRight') navViewer(+1);
        if (e.key === 'Escape') closeThumbViewer();
      });

function onThumbTap(id) {
        const p = findPhoto(id);
        if (!p) return;

        if (p.failed) {
          toast("ä¿å­˜å¤±è´¥ï¼šå»è®¾ç½®/æ¸…ç†ç©ºé—´ï¼ˆæ¨¡æ‹Ÿï¼‰");
          return;
        }

        p.liked = !p.liked;

        setNewPrompt();
        setNewPraise();
        if (praiseCard.classList.contains('expanded')) renderPraiseBody();
        updatePromptVisibilityForFacing();

        if (State.perm.scope === 'full') {
          const ok = Math.random() > 0.10;
          toast(ok ? (p.liked ? "âœ… å·²åŒæ­¥ç³»ç»Ÿå–œæ¬¢ï¼ˆæ¨¡æ‹Ÿï¼‰" : "âœ… å·²å–æ¶ˆç³»ç»Ÿå–œæ¬¢ï¼ˆæ¨¡æ‹Ÿï¼‰")
            : "åŒæ­¥å¤±è´¥ï¼šç³»ç»Ÿé”™è¯¯ï¼ˆä¸é˜»æ–­ï¼‰");
        } else {
          toast(p.liked ? "âœ… å·²æ ‡è®°ï¼ˆä»… App å†…ï¼‰" : "âœ… å·²å–æ¶ˆï¼ˆä»… App å†…ï¼‰");
        }

        renderFilmstrip();
        updateWrapAvailability();
      }

      function microRemind() {
        const n = State.session.photos.length;
        if (n === 10 || n === 15 || (n > 15 && n % 5 === 0)) {
          btnWrap.classList.add('pulse');
          filmstripWrap.classList.add('flash');
        }
      }

      btnNoGood.onclick = () => { setNewPrompt(); setNewPraise(); if (praiseCard.classList.contains('expanded')) renderPraiseBody(); updatePromptVisibilityForFacing(); toast("æ¢ä¸€å¥—å¼•å¯¼ï¼Œæˆ‘ä»¬å†æ¥ä¸€è½®"); };

      // ç›¸å†ŒæŒ‰é’®ï¼ˆå·²ç§»åŠ¨åˆ°åº•éƒ¨å·¦ä¸‹ç¬¬äºŒä¸ªï¼‰
      btnOpenAlbum.onclick = () => toast("ï¼ˆæ¨¡æ‹Ÿï¼‰æ‰“å¼€ç³»ç»Ÿç›¸å†Œï¼šJust Photo Album");

      // ---------- Wrap page (ä¿æŒåŸäº¤äº’) ----------
      const wrapPage = $('#wrapPage');
      const pickGrid = $('#pickGrid');
      const statShots = $('#statShots');
      const statLiked = $('#statLiked');
      const scopeChip = $('#scopeChip');
      const collage = $('#collage');
      const cctx = collage.getContext('2d');

      let selectedWrap = new Set();

      function openWrap() {
        State.s = 'S2';
        wrapPage.classList.add('show');

        const shots = State.session.photos.length;
        const liked = State.session.photos.filter(p => p.liked).length;
        statShots.textContent = `æœ¬è½®æ‹äº† ${shots} å¼ `;
        statLiked.textContent = `æ ‡è®°äº† ${liked} å¼ `;
        scopeChip.textContent = `è¯»å–ï¼š${State.perm.scope === 'jp' ? 'ä»… Just Photo' : 'å…¨éƒ¨ç…§ç‰‡'}`;

        selectedWrap.clear();
        const photos = State.session.photos.slice();
        const likedOnes = photos.filter(p => p.liked && !p.failed);
        let base = likedOnes.length ? likedOnes.slice(-3) : photos.filter(p => !p.failed).slice(-3);
        base.forEach(p => selectedWrap.add(p.id));

        renderPickGrid();
        generateCollagePreview();
      }
      function closeWrap() {
        wrapPage.classList.remove('show');
        State.s = State.session.photos.length ? 'S1' : 'S0';
      }
      btnWrap.onclick = openWrap;
      $('#closeWrap').onclick = closeWrap;
      $('#btnContinueShoot').onclick = () => { toast("ç»§ç»­æ‹"); closeWrap(); };
      $('#btnAlbumFromWrap').onclick = () => toast("ï¼ˆæ¨¡æ‹Ÿï¼‰æ‰“å¼€ç³»ç»Ÿç›¸å†Œï¼šJust Photo Album");

      $('#btnApplyLocation').onclick = () => {
        State.session.location = ($('#locationInput').value || '').trim();
        toast(State.session.location ? "åœ°ç‚¹å·²åº”ç”¨" : "åœ°ç‚¹å·²æ¸…ç©º");
        generateCollagePreview();
      };

      function renderPickGrid() {
        pickGrid.innerHTML = '';
        const photos = State.session.photos.slice().filter(p => !p.failed);
        const list = photos.slice().reverse();
        list.forEach(p => {
          const cell = document.createElement('div');
          cell.className = 'pick' + (selectedWrap.has(p.id) ? ' selected' : '');
          cell.innerHTML = `<img src="${p.thumb}"/><div class="selBadge">${selectedWrap.has(p.id) ? 'å·²é€‰' : ''}</div>`;
          cell.onclick = () => togglePick(p.id);
          pickGrid.appendChild(cell);
        });
      }
      function togglePick(id) {
        if (selectedWrap.has(id)) selectedWrap.delete(id);
        else {
          if (selectedWrap.size >= 3) { toast("æœ€å¤šé€‰ 3 å¼ "); return; }
          selectedWrap.add(id);
        }
        renderPickGrid();
        generateCollagePreview();
      }

      function drawCenterCrop(img, dx, dy, dw, dh) {
        const sw = img.naturalWidth || img.width;
        const sh = img.naturalHeight || img.height;
        if (!sw || !sh) return;

        const targetRatio = dw / dh;
        const srcRatio = sw / sh;

        let sx = 0, sy = 0, sW = sw, sH = sh;
        if (srcRatio > targetRatio) {
          sH = sh;
          sW = sh * targetRatio;
          sx = (sw - sW) / 2;
          sy = 0;
        } else {
          sW = sw;
          sH = sw / targetRatio;
          sx = 0;
          sy = (sh - sH) / 2;
        }
        cctx.drawImage(img, sx, sy, sW, sH, dx, dy, dw, dh);
      }

      function clearCollage() {
        cctx.clearRect(0, 0, collage.width, collage.height);
        cctx.fillStyle = "rgba(0,0,0,.35)";
        cctx.fillRect(0, 0, collage.width, collage.height);
        cctx.fillStyle = "rgba(255,255,255,.35)";
        cctx.font = "42px system-ui";
        cctx.fillText("è¯·é€‰æ‹© 3 å¼ ", 260, 820);
      }

      async function loadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = src;
        });
      }

      async function generateCollagePreview() {
        const ids = [...selectedWrap].slice(0, 3);
        if (ids.length < 3) { clearCollage(); return; }

        cctx.clearRect(0, 0, collage.width, collage.height);
        cctx.fillStyle = "rgba(0,0,0,.25)";
        cctx.fillRect(0, 0, collage.width, collage.height);

        const W = collage.width, H = collage.height;
        const padding = 48;
        const gap = 32;

        const cardX = padding;
        const cardW = W - padding * 2;
        const cardH = (H - padding * 2 - gap * 2) / 3;

        const photos = ids.map(id => findPhoto(id)).filter(Boolean);
        const srcs = photos.map(p => p.real || p.thumb);

        let imgs;
        try { imgs = await Promise.all(srcs.map(loadImage)); }
        catch (e) { clearCollage(); return; }

        for (let i = 0; i < 3; i++) {
          const y = padding + i * (cardH + gap);
          cctx.fillStyle = "rgba(255,255,255,.06)";
          cctx.fillRect(cardX - 6, y - 6, cardW + 12, cardH + 12);

          cctx.save();
          cctx.beginPath();
          cctx.roundRect(cardX, y, cardW, cardH, 24);
          cctx.clip();
          drawCenterCrop(imgs[i], cardX, y, cardW, cardH);
          cctx.restore();
        }

        const d = new Date();
        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        const loc = State.session.location ? ` Â· ${State.session.location}` : "";
        cctx.fillStyle = "rgba(255,255,255,.86)";
        cctx.font = "34px system-ui";
        cctx.fillText(dateStr + loc, 56, 72);

        cctx.fillStyle = "rgba(255,255,255,.55)";
        cctx.font = "26px system-ui";
        cctx.fillText("Powered by Just Photo", W - 360, H - 48);
      }

      if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
          const rr = typeof r === 'number' ? { tl: r, tr: r, br: r, bl: r } : r;
          this.beginPath();
          this.moveTo(x + rr.tl, y);
          this.lineTo(x + w - rr.tr, y);
          this.quadraticCurveTo(x + w, y, x + w, y + rr.tr);
          this.lineTo(x + w, y + h - rr.br);
          this.quadraticCurveTo(x + w, y + h, x + w - rr.br, y + h);
          this.lineTo(x + rr.bl, y + h);
          this.quadraticCurveTo(x, y + h, x, y + h - rr.bl);
          this.lineTo(x, y + rr.tl);
          this.quadraticCurveTo(x, y, x + rr.tl, y);
          this.closePath();
          return this;
        };
      }

      function downloadCanvas(filename) {
        const a = document.createElement('a');
        a.href = collage.toDataURL('image/png');
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      $('#btnSaveCollage').onclick = () => { downloadCanvas("just-photo-collage.png"); toast("å·²ä¿å­˜æ‹¼å›¾ï¼ˆä¸‹è½½æ¨¡æ‹Ÿï¼‰"); };

      $('#btnShareCollage').onclick = async () => {
        try {
          if (navigator.share) {
            const blob = await (await fetch(collage.toDataURL('image/png'))).blob();
            const file = new File([blob], "just-photo-collage.png", { type: "image/png" });
            await navigator.share({ files: [file], title: "Just Photo", text: "è¿™å¼ æ‹¼å›¾ä¸ä¼šä¿®æ”¹ä½ çš„åŸç‰‡ã€‚" });
            toast("å·²åˆ†äº«ï¼ˆç³»ç»Ÿåˆ†äº«ï¼‰");
            return;
          }
        } catch (e) { }
        downloadCanvas("just-photo-collage.png");
        toast("ä¸æ”¯æŒç³»ç»Ÿåˆ†äº«ï¼šå·²æ”¹ä¸ºä¸‹è½½");
      };

      // ---------- Inspo open ----------
      function openInspo2() { openInspo(); }
      btnInspo.onclick = openInspo2;

      // ---------- Start ----------
      showPerm(0);
    })();
  </script>
</body>

</html>