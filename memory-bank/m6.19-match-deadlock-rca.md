# M6.19 Match Deadlock 排障归档（P0-P2 Sprint）

## 背景
- 症状：`blocked_by` 与 PoseSpec 降级配置不一致；live 帧抖动导致结论不可复现。
- 目标：建立“可热重载 + 可复现 + 可审计”的 Match 评估闭环。

## Root Cause
1. MatchDecider 缓存只按 scene 维度缓存，PoseSpec 更新后仍复用旧实例。
2. DebugTools 也有独立缓存，且 key 语义与主链路不一致。
3. Debug 验证只依赖 live frame，无法剥离实时噪声，难以判断逻辑是否正确。
4. `CHIN_UP/CHIN_DOWN` 在真实镜头焦段/脸型分布下漂移明显，不适合继续作为强匹配阻断。

## 实施内容

### Phase 1（P0）缓存一致性 + 热重载
- `MatchDeciderBuilder.cacheFingerprint(spec)`：基于 `prdVersion/changeLog/cues.count` 生成 fingerprint。
- `TierScheduler` decider 缓存 key 改为 `scene|fingerprint`。
- 新增 `TierScheduler.debugReloadPoseSpecAndRebuildDeciders()`。
- DebugTools 增加按钮：`Reload PoseSpec & Rebuild Deciders`，并同步清理 DebugTools 本地 decider 缓存。

### Phase 2（P1）Static Image Hook
- DebugTools 增加 `M6.19 Source` 切换：`live|static`。
- `static` 源从 bundle 读取 `RefTargetDebug.png`，转 `CVPixelBuffer` 后走全链路：
  `VisionPipeline -> ROIComputer -> MetricComputer -> MatchDecider`。
- 探针日志统一输出：
  `source / scene / pose / required / blocked_by / mirrorApplied`。

### Phase 3（P2）CHIN 降级
- 同步修改两份 PoseSpec：
  - `/Users/fanqie/Projects/opencode_just_photo/justphoto_opencode/Resources/PoseSpec.json`
  - `/Users/fanqie/Projects/opencode_just_photo/memory-bank/PoseSpec.json`
- 将 `CHIN_UP` 与 `CHIN_DOWN` 的 `trigger.withRef` 设为 `null`（非强匹配）。
- 追加 changelog：`v1.1.4-final-hotreload`。

## 验收记录
- 构建验证：
  - `xcodebuild -project /Users/fanqie/Projects/opencode_just_photo/justphoto_opencode.xcodeproj -scheme justphoto_opencode -configuration Debug -sdk iphonesimulator -destination 'generic/platform=iOS Simulator' build`
  - 结果：`BUILD SUCCEEDED`（2026-02-26）。
- 配置同步验证：两份 PoseSpec `shasum` 一致。

## 下一步真机验证清单
1. 打开相机预览后进入 DebugTools。
2. 点击 `Reload PoseSpec & Rebuild Deciders`，确认日志打印最新 fingerprint 和 required。
3. 切 `source=static`，对同一静态图连续跑 20 次，检查 `blocked_by` 完全一致。
4. 切 `source=live`，确认日志包含完整探针字段。
5. 检查 `blocked_by` 中不再出现 `CHIN_UP/CHIN_DOWN`。

## 2026-02-26 P0 热修（Vision 饥饿 + 线程阻塞）
- 现象：live 路径长期 `pose=false / joints=0 / rois=nil`，并伴随 `t0_max_ms` 秒级峰值。
- 根因修复：
  - `CameraFrameSource` 去除 `back portrait -> .left` 硬编码，改为基于 `AVCaptureConnection.videoOrientation` + 镜像状态动态映射 EXIF orientation（含 interface fallback）。
  - `VisionPipeline` 去除 `performQueue.sync`，改为 `withCheckedThrowingContinuation + performQueue.async` 异步执行 Vision request。
  - `TierScheduler` 调整为“仅在调度阶段占用 T0 gate”，不再将 gate 绑定到模型运行时长，避免长推理导致 T0 tick 连续饥饿。
- 影响范围（仅胶水层）：未改 `ROIComputer`、未改 `MatchDecider`、未改任何 PoseSpec 阈值。

## 变更文件
- `/Users/fanqie/Projects/opencode_just_photo/justphoto_opencode/Infrastructure/PoseSpec/MatchDecider.swift`
- `/Users/fanqie/Projects/opencode_just_photo/justphoto_opencode/Infrastructure/PoseSpec/VisionPipeline.swift`
- `/Users/fanqie/Projects/opencode_just_photo/justphoto_opencode/Features/Settings/DebugToolsScreen.swift`
- `/Users/fanqie/Projects/opencode_just_photo/justphoto_opencode/Resources/PoseSpec.json`
- `/Users/fanqie/Projects/opencode_just_photo/memory-bank/PoseSpec.json`
- `/Users/fanqie/Projects/opencode_just_photo/memory-bank/progress.md`
