# M4.2 Memo

Date: 2026-02-04

## Goal
Create `SessionRuleGate` as the single source of truth for whether the shutter is enabled.

## What Shipped
- New rule module: `justphoto_opencode/Infrastructure/Session/SessionRuleGate.swift`
  - Deterministic priority (single reason):
    - `camera_not_authorized`
    - `warmup_failed` / `warmup_not_ready`
    - `blocked_by_write_failed`
    - `in_flight_limit_reached` (>= 2)
    - `workset_full` (>= 20)
- Camera uses rule gate: `justphoto_opencode/Features/Camera/CameraScreen.swift`
  - Shutter `.disabled(!shutterGateResult.isEnabled)`.
  - Debug button `ExplainShutterDisabledReason` prints:
    - `ShutterDisabled:<reason>`
    - `ShutterGateDebug: <debugDescription>`
  - Counts refreshed on enter/foreground and after closing sheets.

## Supporting Work (Needed for QA/dev)
- Workset counters: `justphoto_opencode/Infrastructure/Session/WorksetCounter.swift`
  - `workset_count` and `in_flight_count` per PRD state sets.
- SessionRepository counter access:
  - `currentWorksetCounter()`
  - `countWriteFailedItems()`
- DebugTools additions: `justphoto_opencode/Features/Settings/DebugToolsScreen.swift`
  - `PrintCounts`
  - `CreateWriteFailedItem` / `CountWriteFailedItems` / `ClearWriteFailedItems`
    - Used to validate `blocked_by_write_failed` gate (until Viewer retry/abandon flows exist).

## Verification
- Build: `xcodebuild` Debug (iOS Simulator) succeeds.
- Manual checks:
  - With `write_failed` items present, `ExplainShutterDisabledReason` prints:
    - `disabled:blocked_by_write_failed write_failed=<n>`
  - After `ClearWriteFailedItems` (or new session), gate returns `enabled` when other inputs are OK.

## Notes / Follow-ups
- Gate is intended to remain the only place determining shutter availability.
- Viewer-side `retry_write` / `abandon_item` is still pending; until then, `ClearWriteFailedItems` is a dev-only escape hatch.
