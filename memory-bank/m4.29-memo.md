# M4.29 Memo

Date: 2026-02-06

## Goal
Handle “phantom assets” (a stored PhotoKit localIdentifier that can no longer be fetched, commonly after Limited Photos scope changes or user deletion) so the app does not crash or retry forever.

## What Shipped
- New healer module: `justphoto_opencode/Infrastructure/Capture/PhantomAssetHealer.swift`
  - Detects phantom when Photos auth is `.authorized` or `.limited` AND `PHAsset.fetchAssets(withLocalIdentifiers:)` returns 0.
  - MVP heal strategy: prune the local `session_items` row via `SessionRepository.deleteSessionItem(itemId:)`.
  - Console logs:
    - `PhantomAssetDetected: source=... item_id=... asset_id_hash=... auth=...`
    - `PhantomAssetHealed: action=pruned item_id=...`

- Deterministic album archiving failures: `justphoto_opencode/Infrastructure/Capture/AlbumArchiver.swift`
  - Preflights asset/album fetch and throws `AlbumArchiverError.assetNotFound` / `AlbumArchiverError.albumNotFound`.

- Integrated into album retry paths so phantom assets stop retry loops:
  - Auto retry: `justphoto_opencode/Infrastructure/Capture/AlbumAddRetryScheduler.swift`
  - Manual “修复”: `justphoto_opencode/Features/Camera/CameraScreen.swift`

## Supporting Work (Dev/QA)
- Debug tool: `justphoto_opencode/Features/Settings/DebugToolsScreen.swift`
  - Section: “M4.29 Phantom Asset Healer”
  - Action: “Inject + Heal Phantom Asset” (injects a fake asset id, runs healer, shows whether the row was pruned).

## Verification
- Build: `xcodebuild` Debug (iOS Simulator) succeeds.
- Manual checks:
  - When a phantom asset is encountered during album add, console shows `PhantomAssetDetected` and the corresponding `session_items` row is removed, preventing repeated retries.

## Notes / Follow-ups
- M4.30 will emit the required A.13 diagnostics event `phantom_asset_detected` (currently console-only detection).
